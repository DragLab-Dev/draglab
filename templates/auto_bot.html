<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️ Auto Bot - DragLab</title>
    <style>
        /* MENÚ UNIVERSAL INLINE */
        .universal-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        .universal-menu .menu-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.9);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .universal-menu .menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        .universal-menu-content {
            position: absolute;
            right: 0;
            top: 60px;
            background: white;
            min-width: 250px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .universal-menu-content.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .universal-menu-content a,
        .universal-menu-content button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            text-decoration: none;
            color: #333;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .universal-menu-content a:hover,
        .universal-menu-content button:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .universal-menu-content .menu-divider {
            height: 1px;
            background: rgba(0,0,0,0.1);
            margin: 5px 0;
        }
        body.dark-mode .universal-menu-content {
            background: #1e1e2e;
        }
        body.dark-mode .universal-menu-content a,
        body.dark-mode .universal-menu-content button {
            color: #fff;
        }
        body.dark-mode .universal-menu-content .menu-divider {
            background: rgba(255,255,255,0.1);
        }
        /* FIN MENÚ UNIVERSAL */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #f0f0f0;
        }

        body.dark-mode .section {
            background: #1e1e2e;
            color: #f0f0f0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        body.dark-mode .file-item {
            background: #2a2a3e;
            color: #f0f0f0;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .stat-box {
            background: #2a2a3e;
            color: #f0f0f0;
            border: 2px solid #3a3a4e;
        }

        body.dark-mode .info-box {
            background: #252535;
            color: #f0f0f0;
            border-left-color: #667eea;
        }

        body.dark-mode select,
        body.dark-mode input {
            background: #2a2a3e;
            color: #f0f0f0;
            border-color: #4a4a6e;
        }

        body.dark-mode select:focus,
        body.dark-mode input:focus {
            border-color: #667eea;
            background: #323244;
        }

        body.dark-mode .section-header h2,
        body.dark-mode h2,
        body.dark-mode h3 {
            color: #ffffff;
        }

        body.dark-mode label {
            color: #d0d0d0;
        }

        body.dark-mode .file-name {
            color: #f0f0f0;
        }

        body.dark-mode .stat-box p {
            color: #ffffff;
        }

        body.dark-mode .file-size {
            color: #b0b0b0;
        }

        body.dark-mode small {
            color: #c0c0c0;
        }
        
        body.dark-mode p,
        body.dark-mode li {
            color: #e0e0e0;
        }
        
        body.dark-mode strong {
            color: #ffffff;
        }
        
        body.dark-mode .palette-title {
            color: #ffffff;
            font-weight: 700;
        }
        
        body.dark-mode .blocks-palette {
            background: #1e1e2e;
            border-color: #444;
        }
        
        body.dark-mode .drop-zone {
            background: #1e1e2e;
            border-color: #555;
        }
        
        body.dark-mode .drop-zone-title {
            color: #fff;
            font-weight: 600;
        }
        
        body.dark-mode .drop-zone-empty {
            color: #aaa;
        }
        
        body.dark-mode .info-text {
            color: #e0e0e0 !important;
        }
        
        /* Mejor contraste para fondos claros en modo oscuro */
        body.dark-mode [style*="background: #e3f2fd"],
        body.dark-mode [style*="background: #f3e5f5"],
        body.dark-mode [style*="background: #fff3e0"],
        body.dark-mode [style*="background: #e8f5e9"],
        body.dark-mode [style*="background: #f8f9fa"],
        body.dark-mode [style*="background: #fff3cd"],
        body.dark-mode [style*="background: #f8d7da"],
        body.dark-mode [style*="background: #e7f3ff"] {
            background: #2a2a3e !important;
            color: #e0e0e0 !important;
        }
        
        body.dark-mode [style*="background: linear-gradient"] {
            color: #ffffff !important;
        }
        
        body.dark-mode [style*="background: #e3f2fd"] *:not(.dropped-block):not(.dropped-block *),
        body.dark-mode [style*="background: #f3e5f5"] *:not(.dropped-block):not(.dropped-block *),
        body.dark-mode [style*="background: #fff3e0"] *:not(.dropped-block):not(.dropped-block *),
        body.dark-mode [style*="background: #e8f5e9"] *:not(.dropped-block):not(.dropped-block *),
        body.dark-mode [style*="background: #f8f9fa"] *:not(.dropped-block):not(.dropped-block *),
        body.dark-mode [style*="background: #fff3cd"] *:not(.dropped-block):not(.dropped-block *),
        body.dark-mode [style*="background: #f8d7da"] *:not(.dropped-block):not(.dropped-block *),
        body.dark-mode [style*="background: #e7f3ff"] *:not(.dropped-block):not(.dropped-block *) {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode [style*="background: #f8f9fa"] h4,
        body.dark-mode [style*="background: #fff3cd"] h4 {
            color: #ffffff !important;
        }
        
        body.dark-mode .auto-download-text {
            color: #ffffff !important;
        }
        
        /* Asegurar que dropped-block en modo oscuro mantenga colores oscuros */
        body.dark-mode .dropped-block,
        body.dark-mode .dropped-block * {
            background-color: inherit;
            color: inherit;
        }
        
        body.dark-mode .dropped-block label,
        body.dark-mode .dropped-block input,
        body.dark-mode .dropped-block select {
            color: #e0e0e0;
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transition: all 0.3s;
        }

        .lang-toggle {
            position: fixed;
            top: 20px;
            right: 180px;
            background: rgba(255, 100, 150, 0.3);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transition: all 0.3s;
        }

        .dark-mode-toggle:hover,
        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        body.dark-mode .dark-mode-toggle,
        body.dark-mode .lang-toggle {
            background: rgba(100, 100, 120, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Botón de Retroceder */
        .btn-back {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 1001;
        }
        
        .btn-back:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.3);
        }
        
        body.dark-mode .btn-back {
            background: rgba(30,30,46,0.8);
            border-color: rgba(255,255,255,0.2);
        }
        
        /* Menú Desplegable */
        .nav-menu-wrapper {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        
        .menu-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .menu-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.3);
        }
        
        body.dark-mode .menu-toggle {
            background: rgba(30,30,46,0.8);
            border-color: rgba(255,255,255,0.2);
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 60px;
            background: rgba(255,255,255,0.95);
            min-width: 200px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            overflow: hidden;
            backdrop-filter: blur(20px);
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-menu.active {
            display: block;
        }
        
        .dropdown-menu a,
        .dropdown-menu button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            text-decoration: none;
            color: #1a1a2e;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .dropdown-menu a:hover,
        .dropdown-menu button:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        body.dark-mode .dropdown-menu {
            background: rgba(30,30,46,0.95);
        }
        
        body.dark-mode .dropdown-menu a,
        body.dark-mode .dropdown-menu button {
            color: #e0e0e0;
        }
        
        body.dark-mode .dropdown-menu a:hover,
        body.dark-mode .dropdown-menu button:hover {
            background: rgba(102,126,234,0.2);
        }

        body.dark-mode button.btn {
            background: linear-gradient(135deg, #7b8ff0 0%, #9060c2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(123, 143, 240, 0.3);
        }

        body.dark-mode button.btn:hover {
            background: linear-gradient(135deg, #8a9ef5 0%, #a070d2 100%);
        }

        body.dark-mode .section-header {
            border-bottom-color: #3a3a4e;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .section > * {
            max-width: 100%;
            overflow-x: hidden;
        }

        body.dark-mode .section {
            background: #1a1a2e;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #f0f0f0;
        }

        .section-icon {
            font-size: 2em;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.8em;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(450px, 100%), 1fr));
            gap: 30px;
            max-width: 100%;
            overflow: hidden;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        body.dark-mode .btn-secondary {
            background: linear-gradient(135deg, #34a853 0%, #2dd4bf 100%);
            box-shadow: 0 4px 15px rgba(52, 168, 83, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-box {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
        }

        .result-box.show {
            display: block;
        }

        .result-box.success {
            background: #d4edda;
            border-left: 5px solid #28a745;
            color: #155724;
        }

        .result-box.error {
            background: #f8d7da;
            border-left: 5px solid #dc3545;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box.positive {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .stat-box.negative {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .stat-box h3 {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        body.dark-mode .stat-box h3 {
            color: #c0c0c0;
        }

        .stat-box p {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
        }

        body.dark-mode .stat-box.positive {
            background: #1a3d2a;
            border-color: #4ade80;
        }

        body.dark-mode .stat-box.negative {
            background: #3d1a1a;
            border-color: #f87171;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .info-box strong {
            color: #1976D2;
        }

        .info-box small {
            display: block;
            margin-top: 5px;
            color: #555;
        }

        body.dark-mode .info-box small {
            color: #d0d0d0;
        }

        body.dark-mode .info-box strong {
            color: #8a9ef5;
        }

        body.dark-mode .result-box.success {
            background: #1a3d2a;
            border-left-color: #4ade80;
            color: #c0f0d0;
        }

        body.dark-mode .result-box.error {
            background: #3d1a1a;
            border-left-color: #f87171;
            color: #f0c0c0;
        }

        .files-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }

        body.dark-mode .files-list {
            border-color: #3a3a4e;
            background: #1e1e2e;
        }

        .file-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9em;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
        }

        .file-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 500;
        }

        .file-status.not-found {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        body.dark-mode .file-status.not-found {
            background: #3d3520;
            color: #f0d080;
            border-color: #8a7030;
        }

        body.dark-mode .loading p {
            color: #f0f0f0;
        }

        body.dark-mode .spinner {
            border-color: #3a3a4e;
            border-top-color: #8a9ef5;
        }

        .tip-box {
            margin-top: 15px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
        }

        body.dark-mode .tip-box {
            background: #3d3520;
            color: #f0d080;
            border: 1px solid #8a7030;
        }

        body.dark-mode .tip-box strong {
            color: #ffd080;
        }

        .config-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        body.dark-mode .config-box {
            background: #2a2a3e !important;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .config-box h3 {
            color: #ffffff !important;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .config-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        body.dark-mode .config-item {
            border-bottom-color: #3a3a4e;
        }

        .config-label {
            font-weight: 600;
            color: #666;
        }

        body.dark-mode .config-label {
            color: #b0b0b0;
        }

        .config-value {
            color: #333;
            margin-left: 10px;
        }

        body.dark-mode .config-value {
            color: #f0f0f0;
        }

        .stats-title {
            margin-bottom: 15px;
            color: #333;
        }

        body.dark-mode .stats-title {
            color: #ffffff;
        }

        .section-subtitle {
            margin-bottom: 15px;
            color: #333;
        }

        body.dark-mode .section-subtitle {
            color: #ffffff;
        }

        .info-text {
            color: #666;
            line-height: 1.8;
        }

        body.dark-mode .info-text {
            color: #d0d0d0;
        }

        /* ==================== STRATEGY BUILDER ==================== */
        .strategy-builder {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
            max-width: 100%;
        }
        
        .blocks-palette {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            max-height: none;
            overflow: visible;
            transition: opacity 0.2s ease;
            max-width: 100%;
        }
        
        .builder-canvas {
            transition: background 0.2s ease;
        }
        
        /* Cuando se arrastra, la paleta se oculta */
        .blocks-palette.dragging {
            opacity: 0;
            pointer-events: none;
        }
        
        .builder-canvas.dragging-active {
            background: rgba(102, 126, 234, 0.05);
        }

        .palette-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        body.dark-mode .blocks-palette {
            background: #1e1e2e;
            border-color: #444;
        }

        .palette-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        body.dark-mode .palette-title {
            color: #fff;
            font-weight: 700;
        }

        .block {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: move;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .block.indicator {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .block.condition {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .block.value {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .block.operator {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .block-icon {
            margin-right: 8px;
        }

        .builder-canvas {
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            border: 2px dashed #ddd;
            min-height: 600px;
            transition: background 0.2s ease;
            max-width: 100%;
        }

        body.dark-mode .builder-canvas {
            background: #1e1e2e;
            border-color: #3a3a4e;
        }

        .drop-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        body.dark-mode .drop-zone {
            background: #2a2a3e;
            border-color: #667eea;
        }

        .drop-zone.drag-over {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .drop-zone-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.dark-mode .drop-zone-title {
            color: #8a9ef5;
        }

        .drop-zone-empty {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }

        body.dark-mode .drop-zone-empty {
            color: #666;
        }

        .dropped-block {
            background: #ffffff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        body.dark-mode .dropped-block {
            background: #2a2a3e !important;
            border-color: #8a9ef5;
            color: #e0e0e0;
        }

        .dropped-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .dropped-block-title {
            font-weight: 600;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .dropped-block-title {
            color: #8a9ef5;
        }

        .block-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .move-block {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .move-block:hover {
            background: #5568d3;
        }

        .move-block:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        body.dark-mode .move-block {
            background: #8a9ef5;
        }

        body.dark-mode .move-block:hover {
            background: #7a8ee5;
        }

        .remove-block {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .remove-block:hover {
            background: #c82333;
        }

        .block-params {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .param-group {
            margin-bottom: 0;
        }

        .param-group label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        body.dark-mode .param-group label {
            color: #b0b0b0;
        }

        .param-group input,
        .param-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .strategy-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .chart-iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 10px;
        }

        /* ==================== RESPONSIVE MOBILE ==================== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .dark-mode-toggle {
                top: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 14px;
            }

            .header h1 {
                font-size: 2em;
            }

            .header p {
                font-size: 1em;
            }

            .section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .section-header h2 {
                font-size: 1.4em;
            }

            .section-icon {
                font-size: 1.5em;
            }

            .grid-2 {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .stat-box {
                padding: 12px;
            }

            .stat-box h3 {
                font-size: 0.75em;
            }

            .stat-box p {
                font-size: 1.2em;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            input[type="text"],
            input[type="date"],
            input[type="number"],
            select {
                padding: 10px;
                font-size: 16px; /* Evita zoom en iOS */
            }

            .files-list {
                max-height: 200px;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .config-box {
                padding: 15px;
            }

            .config-item {
                font-size: 0.9em;
            }

            .info-text {
                font-size: 0.95em;
            }

            /* Mejorar iframe en móvil */
            iframe {
                height: 400px !important;
            }

            .chart-iframe {
                height: 400px !important;
            }
        }

        @media (max-width: 480px) {
            .dark-mode-toggle {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .lang-toggle {
                top: 55px;
                right: 10px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 1.5em;
                padding: 10px 0;
                padding-top: 50px;
            }

            .header p {
                font-size: 0.85em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-box h3 {
                font-size: 0.85em;
            }

            .section {
                padding: 15px 10px;
                margin-bottom: 15px;
            }

            .section-header h2 {
                font-size: 1.3em;
            }

            .chart-iframe {
                height: 300px !important;
            }

            iframe {
                height: 300px !important;
            }

            .strategy-builder {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .blocks-palette {
                grid-template-columns: 1fr !important;
                gap: 10px;
                padding: 12px;
                max-height: none;
                overflow: visible;
            }
            
            .palette-section {
                margin-bottom: 12px;
            }
            
            .palette-title {
                font-size: 0.95em;
                margin-bottom: 10px;
            }
            
            .block {
                padding: 10px;
                font-size: 0.85em;
                margin-bottom: 6px;
                min-height: 50px;
            }
            
            .block small {
                font-size: 0.7em;
                display: block;
                margin-top: 3px;
            }
            
            .drop-zone {
                min-height: 100px;
            }
            
            .drop-zone-title {
                font-size: 0.9em;
                padding: 8px;
            }
            
            .drop-zone-empty {
                font-size: 0.85em;
                padding: 15px;
            }
            
            .builder-canvas {
                max-height: none;
                overflow-y: visible;
            }

            .block-params {
                grid-template-columns: 1fr;
            }

            /* Construction Overlay - Tablet */
            .construction-content {
                padding: 40px 30px;
                max-width: 90%;
            }

            .construction-icon {
                font-size: 90px;
            }

            .construction-title {
                font-size: 2em;
            }

            .construction-text {
                font-size: 1.05em;
            }

            .construction-features {
                padding: 20px;
            }

            .construction-features li {
                font-size: 0.95em;
            }

            .construction-admin-btn,
            .construction-back-btn {
                padding: 12px 30px;
                font-size: 1em;
            }

            .construction-buttons {
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .dark-mode-toggle {
                top: 15px;
                right: 15px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .lang-toggle {
                top: 15px;
                right: 155px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-box h3 {
                font-size: 0.75em;
            }

            .section {
                padding: 20px;
                margin-bottom: 20px;
            }

            .section-header h2 {
                font-size: 1.4em;
            }

            .chart-iframe {
                height: 400px;
            }

            iframe {
                height: 400px !important;
            }

            .strategy-builder {
                padding: 0;
                gap: 15px;
            }

            .blocks-palette {
                padding: 15px;
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .palette-section {
                gap: 6px;
            }
            
            .palette-title {
                font-size: 0.8em;
                margin-bottom: 10px;
            }
            
            .block {
                padding: 10px;
                margin-bottom: 8px;
                font-size: 0.85em;
            }
            
            .block small {
                font-size: 0.75em;
                display: block;
                margin-top: 4px;
            }
            
            .drop-zone {
                padding: 15px;
            }
            
            .drop-zone-title {
                font-size: 0.9em;
                margin-bottom: 10px;
            }
            
            .drop-zone-empty {
                padding: 20px;
                font-size: 0.85em;
            }
            
            .builder-canvas {
                padding: 15px;
                min-height: 400px;
            }

            .block-params {
                grid-template-columns: 1fr;
            }

            /* Construction Overlay - Mobile */
            .construction-overlay {
                padding: 15px;
                align-items: flex-start;
                padding-top: 30px;
            }

            .construction-content {
                padding: 30px 20px;
                border-radius: 15px;
                max-width: 100%;
            }

            .construction-icon {
                font-size: 70px;
                margin-bottom: 15px;
            }

            .construction-title {
                font-size: 1.6em;
                margin: 15px 0;
            }

            .construction-text {
                font-size: 0.95em;
                margin-bottom: 20px;
            }

            .construction-features {
                padding: 15px;
                margin: 20px 0;
            }

            .construction-features li {
                font-size: 0.85em;
                padding: 8px 0;
            }

            .construction-admin-btn,
            .construction-back-btn {
                padding: 12px 25px;
                font-size: 0.95em;
                width: 100%;
            }

            .construction-buttons {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
                width: 100%;
            }
        }

        /* ==================== MODAL DISCLAIMER ==================== */
        .disclaimer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .disclaimer-modal.show,
        .disclaimer-modal.active {
            display: flex;
        }

        .disclaimer-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        body.dark-mode .disclaimer-content {
            background: #1e1e2e;
            color: #f0f0f0;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .disclaimer-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        body.dark-mode .disclaimer-header {
            border-bottom-color: #3a3a4e;
        }

        .disclaimer-header h2 {
            margin: 0;
            color: #dc3545;
            font-size: 1.5em;
        }

        body.dark-mode .disclaimer-header h2 {
            color: #ff6b6b;
        }

        .disclaimer-text {
            margin-bottom: 25px;
            line-height: 1.8;
        }

        .disclaimer-text p {
            margin-bottom: 15px;
        }

        .disclaimer-text strong {
            color: #dc3545;
        }

        body.dark-mode .disclaimer-text strong {
            color: #ff6b6b;
        }

        .disclaimer-list {
            background: #fff3cd;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
        }

        body.dark-mode .disclaimer-list {
            background: #3d3520;
            border-left-color: #f0ad4e;
        }

        .disclaimer-list ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .disclaimer-list li {
            margin: 8px 0;
        }

        .disclaimer-checkbox {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }

        body.dark-mode .disclaimer-checkbox {
            background: #2a2a3e;
            border-color: #4a4a6e;
        }

        .disclaimer-checkbox:hover {
            border-color: #667eea;
            background: #e7f3ff;
        }

        body.dark-mode .disclaimer-checkbox:hover {
            border-color: #667eea;
            background: #323244;
        }

        .disclaimer-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .disclaimer-checkbox label {
            cursor: pointer;
            font-weight: 600;
            margin: 0;
            flex: 1;
        }

        .disclaimer-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .disclaimer-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .disclaimer-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .disclaimer-btn-cancel:hover {
            background: #5a6268;
        }

        .disclaimer-btn-accept {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .disclaimer-btn-accept:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .disclaimer-btn-accept:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== AUTO BOT CARDS ==================== */
        .bot-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .bot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        body.dark-mode .bot-card {
            background: #2a2a3e;
            border-color: #4a4a6e;
        }

        .bot-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .bot-card-title {
            flex: 1;
            min-width: 200px;
        }

        .bot-card-title h3 {
            margin: 0 0 5px 0;
            font-size: 1.4em;
            color: #333;
        }

        body.dark-mode .bot-card-title h3 {
            color: #fff;
        }

        .bot-card-subtitle {
            margin: 0;
            color: #999;
            font-size: 0.9em;
        }

        .bot-status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .bot-status-active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .bot-status-paused {
            background: #6c757d;
        }

        .bot-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .bot-stat-item {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        body.dark-mode .bot-stat-item {
            background: #1e1e2e;
        }

        .bot-stat-label {
            margin: 0;
            font-size: 0.8em;
            color: #999;
        }

        .bot-stat-value {
            margin: 5px 0 0 0;
            font-size: 1.4em;
            font-weight: 600;
        }

        body.dark-mode .bot-stat-value {
            color: #fff;
        }

        .bot-last-trade {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        body.dark-mode .bot-last-trade {
            background: #1e1e2e;
        }

        .bot-last-trade-title {
            margin: 0 0 5px 0;
            font-weight: 600;
            color: #2196f3;
            font-size: 0.85em;
        }

        body.dark-mode .bot-last-trade-title {
            color: #8a9ef5;
        }

        .bot-last-trade-text {
            margin: 0;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        body.dark-mode .bot-last-trade-text {
            color: #e0e0e0;
        }

        .bot-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .bot-actions button {
            flex: 1;
            min-width: 120px;
        }

        /* ==================== UNDER CONSTRUCTION OVERLAY ==================== */
        .construction-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }

        .construction-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 60px 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: constructionPulse 2s ease-in-out infinite;
            margin: auto;
        }

        @keyframes constructionPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .construction-icon {
            font-size: 120px;
            margin-bottom: 20px;
            animation: constructionRotate 3s linear infinite;
        }

        @keyframes constructionRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .construction-title {
            font-size: 2.5em;
            color: white;
            margin: 20px 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .construction-text {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .construction-features {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            text-align: left;
        }

        .construction-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .construction-features li {
            color: white;
            padding: 10px 0;
            font-size: 1.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .construction-features li:last-child {
            border-bottom: none;
        }

        .construction-admin-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            white-space: nowrap;
        }

        .construction-admin-btn:hover {
            background: white;
            color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.3);
        }

        .construction-back-btn {
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: 2px solid white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            white-space: nowrap;
        }

        .construction-back-btn:hover {
            background: #dc3545;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.5);
        }

        .construction-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        body.dark-mode .construction-content {
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            border: 2px solid #667eea;
        }
    </style>
</head>
<body>
    <!-- OVERLAY DE CONSTRUCCIÓN -->
    <div id="constructionOverlay" class="construction-overlay">
        <div class="construction-content">
            <div class="construction-icon">🚧</div>
            <h1 class="construction-title" data-lang-es="Sección En Construcción" data-lang-en="Section Under Construction">Sección En Construcción</h1>
            <p class="construction-text" data-lang-es="Estamos trabajando arduamente para traerte el mejor sistema de trading automático." data-lang-en="We're working hard to bring you the best automated trading system.">
                Estamos trabajando arduamente para traerte el mejor sistema de trading automático.
            </p>
            
            <div class="construction-features">
                <ul>
                    <li>🤖 <span data-lang-es="Trading automático real en Binance" data-lang-en="Real automated trading on Binance">Trading automático real en Binance</span></li>
                    <li>📊 <span data-lang-es="Estrategias visuales sin programar" data-lang-en="Visual strategies without coding">Estrategias visuales sin programar</span></li>
                    <li>⚡ <span data-lang-es="Ejecución de órdenes en tiempo real" data-lang-en="Real-time order execution">Ejecución de órdenes en tiempo real</span></li>
                    <li>🔒 <span data-lang-es="Conexión segura con API de Binance" data-lang-en="Secure connection with Binance API">Conexión segura con API de Binance</span></li>
                    <li>📈 <span data-lang-es="Gestión de posiciones y riesgo" data-lang-en="Position and risk management">Gestión de posiciones y riesgo</span></li>
                </ul>
            </div>

            <p class="construction-text" style="font-size: 0.95em; margin-top: 25px;" data-lang-es="Pronto estará disponible. ¡Mantente atento!" data-lang-en="Coming soon. Stay tuned!">
                Pronto estará disponible. ¡Mantente atento!
            </p>

            <!-- Botones de acción -->
            <div class="construction-buttons">
                <!-- Botón Volver (para todos) -->
                <button class="construction-back-btn" onclick="window.location.href='/trading-bot'">
                    <span data-lang-es="← Volver Atrás" data-lang-en="← Go Back">← Volver Atrás</span>
                </button>
                
                <!-- Botón Acceso Admin (solo para administradores) -->
                <button id="adminAccessBtn" class="construction-admin-btn" style="display: none;" onclick="unlockConstructionMode()">
                    <span data-lang-es="🔓 Acceso de Administrador" data-lang-en="🔓 Administrator Access">🔓 Acceso de Administrador</span>
                </button>
            </div>
        </div>
    </div>
    <!-- Botón de Retroceder -->
    <button class="btn-back" onclick="window.location.href='/trading-bot'" title="Volver">←</button>
    
    <!-- MENÚ UNIVERSAL -->
    <div class="universal-menu">
        <button class="menu-btn" onclick="toggleUniversalMenu()" title="Menú">☰</button>
        <div class="universal-menu-content" id="universalMenu">
            <a href="/">🏠 Inicio</a>
            <a href="/backtest">🧱 Visual Strategy Builder</a>
            <a href="/trading-bot">🤖 Trading Bot</a>
            <div class="menu-divider"></div>
            <a href="/user-panel">👤 Mi Cuenta</a>
            <a href="/subscriptions">💎 Suscripciones</a>
            <a href="/admin/panel" id="adminMenuLink" style="display: none;">🔒 Panel Admin</a>
            <div class="menu-divider"></div>
            <button onclick="toggleDarkMode()">🌙 Modo Oscuro</button>
            <button onclick="toggleLanguage()">🌐 Idioma</button>
            <div class="menu-divider"></div>
            <button onclick="logout()">🚪 Cerrar Sesión</button>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1 data-lang-es="⚙️ Auto Bot - Trading Automático en Exchange" data-lang-en="⚙️ Auto Bot - Automated Exchange Trading">⚙️ Auto Bot - Trading Automático en Exchange</h1>
            <p data-lang-es="Crea estrategias mediante Bloques - SIN Programar - Trading automático real con Binance" data-lang-en="Build strategies with Blocks - NO Coding - Real automated trading with Binance">Crea estrategias mediante Bloques - SIN Programar - Trading automático real con Binance</p>
        </div>

        <!-- SECCIÓN 1: GUÍA DE USO -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">�</span>
                <h2 data-lang-es="Guia de Uso" data-lang-en="User Guide">1. Guía de Uso</h2>
            </div>

            <div class="info-text" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: white;" data-lang-es="🎯 Cómo Funciona Visual Strategy Builder" data-lang-en="🎯 How Visual Strategy Builder Works">🎯 Cómo Funciona Visual Strategy Builder</h3>
                <p style="margin: 15px 0; line-height: 2; font-size: 1.05em;">
                    <strong data-lang-es="Paso 1:" data-lang-en="Step 1:">Paso 1:</strong> <span data-lang-es="Arrastra bloques desde la paleta al área de construcción" data-lang-en="Drag blocks from the palette to the build area">Arrastra bloques desde la paleta al área de construcción</span><br>
                    <strong data-lang-es="Paso 2:" data-lang-en="Step 2:">Paso 2:</strong> <span data-lang-es="Combina Indicadores (EMA, RSI, etc.) con Operadores (>, <, etc.)" data-lang-en="Combine Indicators (EMA, RSI, etc.) with Operators (>, <, etc.)">Combina Indicadores (EMA, RSI, etc.) con Operadores (>, <, etc.)</span><br>
                    <strong data-lang-es="Paso 3:" data-lang-en="Step 3:">Paso 3:</strong> <span data-lang-es="Usa bloques de Lógica (AND, OR) para condiciones complejas" data-lang-en="Use Logic blocks (AND, OR) for complex conditions">Usa bloques de Lógica (AND, OR) para condiciones complejas</span><br>
                    <strong data-lang-es="Paso 4:" data-lang-en="Step 4:">Paso 4:</strong> <span data-lang-es="Escribe el símbolo del activo y ejecuta el backtest" data-lang-en="Enter the asset symbol and run the backtest">Escribe el símbolo del activo y ejecuta el backtest</span><br>
                    <strong data-lang-es="Paso 5:" data-lang-en="Step 5:">Paso 5:</strong> <span data-lang-es="Los datos se descargan automáticamente desde Binance" data-lang-en="Data is downloaded automatically from Binance">Los datos se descargan automáticamente desde Binance</span><br>
                    <strong data-lang-es="Paso 6:" data-lang-en="Step 6:">Paso 6:</strong> <span data-lang-es="Analiza resultados y optimiza tu estrategia" data-lang-en="Analyze results and optimize your strategy">Analiza resultados y optimiza tu estrategia</span>
                </p>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong data-lang-es="🚀 Sin Configuración Previa:" data-lang-en="🚀 No Prior Setup:">🚀 Sin Configuración Previa:</strong> <span class="auto-download-text" data-lang-es="No necesitas descargar datos manualmente, todo es automático!" data-lang-en="You don't need to download data manually, everything is automatic!">No necesitas descargar datos manualmente, todo es automático!</span>
                </div>
            </div>

            <h3 style="margin: 25px 0 15px 0; color: #333;" data-lang-es="📚 Ejemplos Prácticos" data-lang-en="📚 Practical Examples">📚 Ejemplos Prácticos</h3>

            <div class="grid-2" style="margin-bottom: 25px;">
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3;">
                    <h4 style="margin-top: 0; color: #1976d2;" data-lang-es="📈 Ejemplo 1: Estrategia EMA Simple" data-lang-en="📈 Example 1: Simple EMA Strategy">📈 Ejemplo 1: Estrategia EMA Simple</h4>
                    <p style="line-height: 1.8; margin: 10px 0;">
                        <strong data-lang-es="Entrada LONG:" data-lang-en="LONG Entry:">Entrada LONG:</strong><br>
                        <span data-lang-es='1️⃣ Arrastra "Precio" → 2️⃣ "Mayor que (>)" → 3️⃣ "EMA" (período: 50)' data-lang-en='1️⃣ Drag "Price" → 2️⃣ "Greater than (>)" → 3️⃣ "EMA" (period: 50)'>1️⃣ Arrastra "Precio" → 2️⃣ "Mayor que (>)" → 3️⃣ "EMA" (período: 50)</span><br>
                        <strong data-lang-es="💡 Significado LONG:" data-lang-en="💡 LONG Meaning:">💡 Significado LONG:</strong> <span data-lang-es="Compra cuando el precio sube por encima de la EMA de 50 períodos (tendencia alcista confirmada)" data-lang-en="Buy when price rises above 50-period EMA (confirmed uptrend)">Compra cuando el precio sube por encima de la EMA de 50 períodos (tendencia alcista confirmada)</span><br><br>
                        <strong data-lang-es="Salida LONG:" data-lang-en="LONG Exit:">Salida LONG:</strong><br>
                        <span data-lang-es='1️⃣ Arrastra "Precio" → 2️⃣ "Menor que (<)" → 3️⃣ "EMA" (período: 50)' data-lang-en='1️⃣ Drag "Price" → 2️⃣ "Less than (<)" → 3️⃣ "EMA" (period: 50)'>1️⃣ Arrastra "Precio" → 2️⃣ "Menor que (<)" → 3️⃣ "EMA" (período: 50)</span><br>
                        <strong data-lang-es="💡 Significado:" data-lang-en="💡 Meaning:">💡 Significado:</strong> <span data-lang-es="Vende cuando el precio cae por debajo de la EMA (pérdida de momentum alcista)" data-lang-en="Sell when price falls below EMA (loss of bullish momentum)">Vende cuando el precio cae por debajo de la EMA (pérdida de momentum alcista)</span>
                    </p>
                </div>

                <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; border-left: 4px solid #9c27b0;">
                    <h4 style="margin-top: 0; color: #7b1fa2;" data-lang-es="⚡ Ejemplo 2: RSI Sobrecompra/Sobreventa" data-lang-en="⚡ Example 2: RSI Overbought/Oversold">⚡ Ejemplo 2: RSI Sobrecompra/Sobreventa</h4>
                    <p style="line-height: 1.8; margin: 10px 0;">
                        <strong data-lang-es="Entrada LONG:" data-lang-en="LONG Entry:">Entrada LONG:</strong><br>
                        <span data-lang-es='1️⃣ "RSI" (período: 14) → 2️⃣ "Menor que (<)" → 3️⃣ "Número" (valor: 30)' data-lang-en='1️⃣ "RSI" (period: 14) → 2️⃣ "Less than (<)" → 3️⃣ "Number" (value: 30)'>1️⃣ "RSI" (período: 14) → 2️⃣ "Menor que (<)" → 3️⃣ "Número" (valor: 30)</span><br>
                        <strong data-lang-es="💡 Significado LONG:" data-lang-en="💡 LONG Meaning:">💡 Significado LONG:</strong> <span data-lang-es="Compra en zona de sobreventa cuando el RSI está por debajo de 30 (precio muy bajo, probable rebote)" data-lang-en="Buy in oversold zone when RSI is below 30 (very low price, likely bounce)">Compra en zona de sobreventa cuando el RSI está por debajo de 30 (precio muy bajo, probable rebote)</span><br><br>
                        <strong data-lang-es="Entrada SHORT:" data-lang-en="SHORT Entry:">Entrada SHORT:</strong><br>
                        <span data-lang-es='1️⃣ "RSI" (período: 14) → 2️⃣ "Mayor que (>)" → 3️⃣ "Número" (valor: 70)' data-lang-en='1️⃣ "RSI" (period: 14) → 2️⃣ "Greater than (>)" → 3️⃣ "Number" (value: 70)'>1️⃣ "RSI" (período: 14) → 2️⃣ "Mayor que (>)" → 3️⃣ "Número" (valor: 70)</span><br>
                        <strong data-lang-es="💡 Significado SHORT:" data-lang-en="💡 SHORT Meaning:">💡 Significado SHORT:</strong> <span data-lang-es="Vende en corto cuando RSI supera 70 (sobrecompra, probable corrección bajista)" data-lang-en="Sell short when RSI exceeds 70 (overbought, likely bearish correction)">Vende en corto cuando RSI supera 70 (sobrecompra, probable corrección bajista)</span>
                    </p>
                </div>
            </div>

            <div class="grid-2" style="margin-bottom: 25px;">
                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800;">
                    <h4 style="margin-top: 0; color: #f57c00;" data-lang-es="🌊 Ejemplo 3: MACD Crossover" data-lang-en="🌊 Example 3: MACD Crossover">🌊 Ejemplo 3: MACD Crossover</h4>
                    <p style="line-height: 1.8; margin: 10px 0;">
                        <strong data-lang-es="Entrada LONG:" data-lang-en="LONG Entry:">Entrada LONG:</strong><br>
                        <span data-lang-es='1️⃣ "MACD" → 2️⃣ "Cruza (✖)" → 3️⃣ "Mayor que (>)" → 4️⃣ "Número" (0)' data-lang-en='1️⃣ "MACD" → 2️⃣ "Crosses (✖)" → 3️⃣ "Greater than (>)" → 4️⃣ "Number" (0)'>1️⃣ "MACD" → 2️⃣ "Cruza (✖)" → 3️⃣ "Mayor que (>)" → 4️⃣ "Número" (0)</span><br>
                        <strong data-lang-es="💡 Significado LONG:" data-lang-en="💡 LONG Meaning:">💡 Significado LONG:</strong> <span data-lang-es="Compra cuando MACD cruza por encima de la línea de señal en territorio positivo (fuerte momentum alcista)" data-lang-en="Buy when MACD crosses above signal line in positive territory (strong bullish momentum)">Compra cuando MACD cruza por encima de la línea de señal en territorio positivo (fuerte momentum alcista)</span><br><br>
                        <strong data-lang-es="Entrada SHORT:" data-lang-en="SHORT Entry:">Entrada SHORT:</strong><br>
                        <span data-lang-es='1️⃣ "MACD" → 2️⃣ "Cruza (✖)" → 3️⃣ "Menor que (<)" → 4️⃣ "Número" (0)' data-lang-en='1️⃣ "MACD" → 2️⃣ "Crosses (✖)" → 3️⃣ "Less than (<)" → 4️⃣ "Number" (0)'>1️⃣ "MACD" → 2️⃣ "Cruza (✖)" → 3️⃣ "Menor que (<)" → 4️⃣ "Número" (0)</span><br>
                        <strong data-lang-es="💡 Significado SHORT:" data-lang-en="💡 SHORT Meaning:">💡 Significado SHORT:</strong> <span data-lang-es="Vende en corto cuando MACD cruza por debajo de señal en territorio negativo (fuerte momentum bajista)" data-lang-en="Sell short when MACD crosses below signal in negative territory (strong bearish momentum)">Vende en corto cuando MACD cruza por debajo de señal en territorio negativo (fuerte momentum bajista)</span>
                    </p>
                </div>

                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border-left: 4px solid #4caf50;">
                    <h4 style="margin-top: 0; color: #388e3c;" data-lang-es="🎯 Ejemplo 4: Estrategia Combinada (Avanzado)" data-lang-en="🎯 Example 4: Combined Strategy (Advanced)">🎯 Ejemplo 4: Estrategia Combinada (Avanzado)</h4>
                    <p style="line-height: 1.8; margin: 10px 0;">
                        <strong data-lang-es="Entrada LONG:" data-lang-en="LONG Entry:">Entrada LONG:</strong><br>
                        <span data-lang-es='1️⃣ "Precio" > "EMA(50)" → 2️⃣ "AND (∧)" → 3️⃣ "RSI(14)" > "Número(50)"' data-lang-en='1️⃣ "Price" > "EMA(50)" → 2️⃣ "AND (∧)" → 3️⃣ "RSI(14)" > "Number(50)"'>1️⃣ "Precio" > "EMA(50)" → 2️⃣ "AND (∧)" → 3️⃣ "RSI(14)" > "Número(50)"</span><br>
                        <strong data-lang-es="💡 Significado LONG:" data-lang-en="💡 LONG Meaning:">💡 Significado LONG:</strong> <span data-lang-es="Solo compra si AMBAS condiciones se cumplen: precio arriba de EMA Y RSI en zona positiva (confirmación doble de tendencia alcista)" data-lang-en="Only buy if BOTH conditions are met: price above EMA AND RSI in positive zone (double confirmation of uptrend)">Solo compra si AMBAS condiciones se cumplen: precio arriba de EMA Y RSI en zona positiva (confirmación doble de tendencia alcista)</span><br><br>
                        <strong data-lang-es="Entrada SHORT:" data-lang-en="SHORT Entry:">Entrada SHORT:</strong><br>
                        <span data-lang-es='1️⃣ "Precio" < "EMA(50)" → 2️⃣ "AND (∧)" → 3️⃣ "RSI(14)" < "Número(50)"' data-lang-en='1️⃣ "Price" < "EMA(50)" → 2️⃣ "AND (∧)" → 3️⃣ "RSI(14)" < "Number(50)"'>1️⃣ "Precio" < "EMA(50)" → 2️⃣ "AND (∧)" → 3️⃣ "RSI(14)" < "Número(50)"</span><br>
                        <strong data-lang-es="💡 Significado SHORT:" data-lang-en="💡 SHORT Meaning:">💡 Significado SHORT:</strong> <span data-lang-es="Solo vende en corto si AMBAS condiciones se cumplen: precio debajo de EMA Y RSI en zona negativa (confirmación doble de tendencia bajista)" data-lang-en="Only sell short if BOTH conditions are met: price below EMA AND RSI in negative zone (double confirmation of downtrend)">Solo vende en corto si AMBAS condiciones se cumplen: precio debajo de EMA Y RSI en zona negativa (confirmación doble de tendencia bajista)</span><br><br>
                        <strong data-lang-es="Salida LONG:" data-lang-en="LONG Exit:">Salida LONG:</strong> <span data-lang-es='"RSI(14)" > "Número(70)" (Sobrecompra)' data-lang-en='"RSI(14)" > "Number(70)" (Overbought)'>"RSI(14)" > "Número(70)" (Sobrecompra)</span><br>
                        <strong data-lang-es="Salida SHORT:" data-lang-en="SHORT Exit:">Salida SHORT:</strong> <span data-lang-es='"RSI(14)" < "Número(30)" (Sobreventa)' data-lang-en='"RSI(14)" < "Number(30)" (Oversold)'>"RSI(14)" < "Número(30)" (Sobreventa)</span>
                    </p>
                </div>
            </div>

            <div class="grid-2">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-top: 0;" data-lang-es="📦 Indicadores Disponibles" data-lang-en="📦 Available Indicators">📦 Indicadores Disponibles</h4>
                    <ul style="line-height: 2; margin: 10px 0;">
                        <li data-lang-es="EMA/SMA: Medias móviles exponencial y simple" data-lang-en="EMA/SMA: Exponential and simple moving averages"><strong>EMA/SMA:</strong> Medias móviles exponencial y simple</li>
                        <li data-lang-es="RSI: Índice de Fuerza Relativa (sobrecompra/sobreventa)" data-lang-en="RSI: Relative Strength Index (overbought/oversold)"><strong>RSI:</strong> Índice de Fuerza Relativa (sobrecompra/sobreventa)</li>
                        <li data-lang-es="MACD: Convergencia/Divergencia (momentum)" data-lang-en="MACD: Convergence/Divergence (momentum)"><strong>MACD:</strong> Convergencia/Divergencia (momentum)</li>
                        <li data-lang-es="Bollinger: Bandas de volatilidad superior/media/inferior" data-lang-en="Bollinger: Upper/middle/lower volatility bands"><strong>Bollinger:</strong> Bandas de volatilidad superior/media/inferior</li>
                        <li data-lang-es="ATR: Average True Range (volatilidad)" data-lang-en="ATR: Average True Range (volatility)"><strong>ATR:</strong> Average True Range (volatilidad)</li>
                        <li data-lang-es="Swing: Máximos/Mínimos locales" data-lang-en="Swing: Local highs/lows"><strong>Swing:</strong> Máximos/Mínimos locales</li>
                    </ul>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-top: 0;" data-lang-es="⚡ Operadores & Lógica" data-lang-en="⚡ Operators & Logic">⚡ Operadores & Lógica</h4>
                    <ul style="line-height: 2; margin: 10px 0;">
                        <li data-lang-es="> Mayor que: Precio > EMA" data-lang-en="> Greater than: Price > EMA"><strong>> Mayor que:</strong> Precio > EMA</li>
                        <li data-lang-es="< Menor que: RSI < 30" data-lang-en="< Less than: RSI < 30"><strong>< Menor que:</strong> RSI < 30</li>
                        <li data-lang-es="≥ ≤ = ≠ Otras comparaciones" data-lang-en="≥ ≤ = ≠ Other comparisons"><strong>≥ ≤ = ≠</strong> Otras comparaciones</li>
                        <li data-lang-es="✖ Cruza: Detecta cuando una línea cruza otra" data-lang-en="✖ Crosses: Detects when one line crosses another"><strong>✖ Cruza:</strong> Detecta cuando una línea cruza otra</li>
                        <li data-lang-es="AND (∧): Ambas condiciones deben cumplirse" data-lang-en="AND (∧): Both conditions must be met"><strong>AND (∧):</strong> Ambas condiciones deben cumplirse</li>
                        <li data-lang-es="OR (∨): Al menos una condición" data-lang-en="OR (∨): At least one condition"><strong>OR (∨):</strong> Al menos una condición</li>
                        <li data-lang-es="NOT/XOR/NAND/NOR: Lógica avanzada" data-lang-en="NOT/XOR/NAND/NOR: Advanced logic"><strong>NOT/XOR/NAND/NOR:</strong> Lógica avanzada</li>
                    </ul>
                </div>
            </div>

            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin-top: 25px; border-radius: 5px;">
                <h4 style="margin-top: 0; color: #f57f17;" data-lang-es="⚠️ Importante - Configurar Estrategia" data-lang-en="⚠️ Important - Configure Strategy">⚠️ Importante - Configurar Estrategia</h4>
                <p style="margin: 10px 0; line-height: 1.8;">
                    <span data-lang-es="DEBES configurar al menos 1 condición en 'Entrada LONG' o 'Entrada SHORT' antes de ejecutar el backtest. Si no arrastras ningún bloque, el sistema mostrará un error al intentar ejecutar." data-lang-en="You MUST configure at least 1 condition in 'LONG Entry' or 'SHORT Entry' before running the backtest. If you don't drag any blocks, the system will show an error when trying to execute."><strong>DEBES configurar al menos 1 condición</strong> en "Entrada LONG" o "Entrada SHORT" antes de ejecutar el backtest.<br>
                    Si no arrastras ningún bloque, el sistema mostrará un error al intentar ejecutar.</span>
                </p>
            </div>
            </div>
        </div>

        <!-- SECCIÓN 2: CONSTRUCTOR VISUAL -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">🎨</span>
                <h2 data-lang-es="2. Constructor Visual de Estrategia" data-lang-en="2. Visual Strategy Builder">2. Constructor Visual de Estrategia</h2>
            </div>

            <p class="info-text" style="margin-bottom: 20px;" data-lang-es="Arrastra y suelta bloques para construir tu estrategia de trading de forma visual." data-lang-en="Drag and drop blocks to build your trading strategy visually.">
                Arrastra y suelta bloques para construir tu estrategia de trading de forma visual.
            </p>

            <div class="strategy-builder">
                <!-- Paleta de bloques REORGANIZADA EN GRID HORIZONTAL -->
                <div class="blocks-palette">
                    <!-- Sección Indicadores -->
                    <div class="palette-section">
                        <div class="palette-title" data-lang-es="📊 Indicadores" data-lang-en="📊 Indicators">📊 Indicadores</div>
                        <div class="block indicator" draggable="true" data-type="indicator" data-name="EMA" title="Media Móvil Exponencial">
                            <span class="block-icon">📈</span> EMA<br><small>Media Exp.</small>
                        </div>
                        <div class="block indicator" draggable="true" data-type="indicator" data-name="SMA" title="Media Móvil Simple">
                            <span class="block-icon">📉</span> SMA<br><small>Media Simple</small>
                        </div>
                        <div class="block indicator" draggable="true" data-type="indicator" data-name="RSI" title="Índice de Fuerza Relativa">
                            <span class="block-icon">⚡</span> RSI<br><small>Fuerza</small>
                        </div>
                        <div class="block indicator" draggable="true" data-type="indicator" data-name="MACD" title="MACD">
                            <span class="block-icon">🌊</span> MACD<br><small>Momentum</small>
                        </div>
                    </div>
                    
                    <!-- Sección Más Indicadores -->
                    <div class="palette-section">
                        <div class="palette-title" data-lang-es="📐 Más Indicadores" data-lang-en="📐 More Indicators">📐 Más Indicadores</div>
                        <div class="block indicator" draggable="true" data-type="indicator" data-name="BBands" title="Bandas de Bollinger">
                            <span class="block-icon">📏</span> Bollinger<br><small>Volatilidad</small>
                        </div>
                        <div class="block indicator" draggable="true" data-type="indicator" data-name="ATR" title="Average True Range">
                            <span class="block-icon">📊</span> ATR<br><small>Rango</small>
                        </div>
                        <div class="block indicator" draggable="true" data-type="indicator" data-name="Swing" title="Swing High/Low">
                            <span class="block-icon">🔄</span> Swing<br><small>Máx/Mín</small>
                        </div>
                    </div>
                    
                    <!-- Sección Valores -->
                    <div class="palette-section">
                        <div class="palette-title" data-lang-es="💰 Valores" data-lang-en="💰 Values">💰 Valores</div>
                        <div class="block value" draggable="true" data-type="value" data-name="Price" title="Precio actual">
                            <span class="block-icon">💵</span> Precio<br><small>Actual</small>
                        </div>
                        <div class="block value" draggable="true" data-type="value" data-name="Number" title="Número fijo">
                            <span class="block-icon">🔢</span> Número<br><small>Fijo</small>
                        </div>
                        <div class="block value" draggable="true" data-type="value" data-name="Percentage" title="Porcentaje">
                            <span class="block-icon">%</span> Porcentaje<br><small>%</small>
                        </div>
                    </div>
                    
                    <!-- Sección Operadores -->
                    <div class="palette-section">
                        <div class="palette-title" data-lang-es="⚡ Comparadores" data-lang-en="⚡ Comparators">⚡ Comparadores</div>
                        <div class="block operator" draggable="true" data-type="operator" data-name="GreaterThan" title="Mayor que">
                            <span class="block-icon">></span> Mayor<br><small>A > B</small>
                        </div>
                        <div class="block operator" draggable="true" data-type="operator" data-name="LessThan" title="Menor que">
                            <span class="block-icon"><</span> Menor<br><small>A < B</small>
                        </div>
                        <div class="block operator" draggable="true" data-type="operator" data-name="GreaterOrEqual" title="Mayor o igual">
                            <span class="block-icon">≥</span> Mayor/Igual<br><small>A ≥ B</small>
                        </div>
                        <div class="block operator" draggable="true" data-type="operator" data-name="LessOrEqual" title="Menor o igual">
                            <span class="block-icon">≤</span> Menor/Igual<br><small>A ≤ B</small>
                        </div>
                        <div class="block operator" draggable="true" data-type="operator" data-name="Equal" title="Igual">
                            <span class="block-icon">=</span> Igual<br><small>A = B</small>
                        </div>
                        <div class="block operator" draggable="true" data-type="operator" data-name="NotEqual" title="Diferente">
                            <span class="block-icon">≠</span> Diferente<br><small>A ≠ B</small>
                        </div>
                        <div class="block operator" draggable="true" data-type="operator" data-name="Crosses" title="Cruza">
                            <span class="block-icon">✖</span> Cruza<br><small>Crossover</small>
                        </div>
                    </div>
                    
                    <!-- Sección Lógica -->
                    <div class="palette-section">
                        <div class="palette-title" data-lang-es="🎯 Lógica" data-lang-en="🎯 Logic">🎯 Lógica</div>
                        <div class="block condition" draggable="true" data-type="condition" data-name="AND" title="Y lógico">
                            <span class="block-icon">∧</span> AND<br><small>A y B</small>
                        </div>
                        <div class="block condition" draggable="true" data-type="condition" data-name="OR" title="O lógico">
                            <span class="block-icon">∨</span> OR<br><small>A o B</small>
                        </div>
                        <div class="block condition" draggable="true" data-type="condition" data-name="NOT" title="Negación">
                            <span class="block-icon">¬</span> NOT<br><small>Niega</small>
                        </div>
                        <div class="block condition" draggable="true" data-type="condition" data-name="XOR" title="O exclusivo">
                            <span class="block-icon">⊕</span> XOR<br><small>Solo uno</small>
                        </div>
                        <div class="block condition" draggable="true" data-type="condition" data-name="NAND" title="NAND">
                            <span class="block-icon">⊼</span> NAND<br><small>NO ambos</small>
                        </div>
                        <div class="block condition" draggable="true" data-type="condition" data-name="NOR" title="NOR">
                            <span class="block-icon">⊽</span> NOR<br><small>Ninguno</small>
                        </div>
                    </div>
                </div>

                <!-- Canvas de construcción -->
                <div class="builder-canvas">
                    <!-- Zona de entrada LONG -->
                    <div class="drop-zone" id="entry_long_zone" data-zone="entry_long">
                        <div class="drop-zone-title">
                            <span>📈</span>
                            <span data-lang-es="Condiciones de Entrada LONG" data-lang-en="LONG Entry Conditions">Condiciones de Entrada LONG</span>
                        </div>
                        <div class="drop-zone-content">
                            <div class="drop-zone-empty" data-lang-es="Arrastra bloques aquí para definir cuándo entrar en posición LONG" data-lang-en="Drag blocks here to define when to enter LONG position">
                                Arrastra bloques aquí para definir cuándo entrar en posición LONG
                            </div>
                        </div>
                    </div>

                    <!-- Zona de salida LONG -->
                    <div class="drop-zone" id="exit_long_zone" data-zone="exit_long">
                        <div class="drop-zone-title">
                            <span>🚪</span>
                            <span data-lang-es="Condiciones de Salida LONG" data-lang-en="LONG Exit Conditions">Condiciones de Salida LONG</span>
                        </div>
                        <div class="drop-zone-content">
                            <div class="drop-zone-empty" data-lang-es="Arrastra bloques aquí para definir cuándo salir de posición LONG" data-lang-en="Drag blocks here to define when to exit LONG position">
                                Arrastra bloques aquí para definir cuándo salir de posición LONG
                            </div>
                        </div>
                    </div>

                    <!-- Zona de entrada SHORT -->
                    <div class="drop-zone" id="entry_short_zone" data-zone="entry_short">
                        <div class="drop-zone-title">
                            <span>📉</span>
                            <span data-lang-es="Condiciones de Entrada SHORT" data-lang-en="SHORT Entry Conditions">Condiciones de Entrada SHORT</span>
                        </div>
                        <div class="drop-zone-content">
                            <div class="drop-zone-empty" data-lang-es="Arrastra bloques aquí para definir cuándo entrar en posición SHORT" data-lang-en="Drag blocks here to define when to enter SHORT position">
                                Arrastra bloques aquí para definir cuándo entrar en posición SHORT
                            </div>
                        </div>
                    </div>

                    <!-- Zona de salida SHORT -->
                    <div class="drop-zone" id="exit_short_zone" data-zone="exit_short">
                        <div class="drop-zone-title">
                            <span>🚪</span>
                            <span data-lang-es="Condiciones de Salida SHORT" data-lang-en="SHORT Exit Conditions">Condiciones de Salida SHORT</span>
                        </div>
                        <div class="drop-zone-content">
                            <div class="drop-zone-empty" data-lang-es="Arrastra bloques aquí para definir cuándo salir de posición SHORT" data-lang-en="Drag blocks here to define when to exit SHORT position">
                                Arrastra bloques aquí para definir cuándo salir de posición SHORT
                            </div>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="strategy-actions">
                        <button class="btn btn-secondary" onclick="clearStrategy()" data-lang-es="🗑️ Limpiar Todo" data-lang-en="🗑️ Clear All">🗑️ Limpiar Todo</button>
                        <button class="btn btn-secondary" onclick="exportStrategy()" data-lang-es="📥 Exportar Estrategia" data-lang-en="📥 Export Strategy">📥 Exportar Estrategia</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" data-lang-es="📤 Importar Estrategia" data-lang-en="📤 Import Strategy">📤 Importar Estrategia</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importStrategy(event)">
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 3: MIS BOTS DE TRADING AUTOMÁTICO -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">🤖</span>
                <h2 data-lang-es="3. Mis Bots de Trading Automático" data-lang-en="3. My Automated Trading Bots">3. Mis Bots de Trading Automático</h2>
            </div>

            <p class="info-text" style="margin-bottom: 20px; background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                <strong data-lang-es="🤖 Gestión de Bots:" data-lang-en="🤖 Bot Management:">🤖 Gestión de Bots:</strong> <span data-lang-es="Crea, pausa, activa y administra múltiples bots de trading automático con diferentes estrategias." data-lang-en="Create, pause, activate and manage multiple automated trading bots with different strategies.">Crea, pausa, activa y administra múltiples bots de trading automático con diferentes estrategias.</span>
            </p>

            <!-- Botón para crear nuevo bot -->
            <div style="margin-bottom: 30px; text-align: center;">
                <button onclick="showCreateAutoBotModal()" class="btn" style="max-width: 400px; margin: 0 auto;">
                    <span data-lang-es="➕ Crear Nuevo Bot" data-lang-en="➕ Create New Bot">➕ Crear Nuevo Bot</span>
                </button>
            </div>

            <!-- Lista de Bots Creados -->
            <div id="auto_bots_list" style="margin-top: 20px;">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p style="font-size: 1.2em;" data-lang-es="📋 No tienes bots creados aún" data-lang-en="📋 You don't have any bots yet">📋 No tienes bots creados aún</p>
                    <p style="font-size: 0.9em; margin-top: 10px;" data-lang-es="Crea tu primer bot con la estrategia que diseñaste arriba" data-lang-en="Create your first bot with the strategy you designed above">Crea tu primer bot con la estrategia que diseñaste arriba</p>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: CREAR/EDITAR AUTO BOT -->
    <div id="createAutoBotModal" class="disclaimer-modal">
        <div class="disclaimer-content" style="max-width: 800px;">
            <div class="disclaimer-header">
                <span style="font-size: 2em;">🤖</span>
                <h2 id="autoModalTitle" data-lang-es="Crear Nuevo Bot de Trading" data-lang-en="Create New Trading Bot">Crear Nuevo Bot de Trading</h2>
            </div>

            <form id="autoBotConfigForm" onsubmit="saveAutoBotConfig(event)">
                <input type="hidden" id="edit_auto_bot_id">

                <div class="form-group">
                    <label for="auto_bot_name" data-lang-es="Nombre del Bot" data-lang-en="Bot Name">Nombre del Bot</label>
                    <input type="text" id="auto_bot_name" placeholder="Mi Bot BTC" required>
                    <small data-lang-es="Nombre descriptivo para identificar este bot" data-lang-en="Descriptive name to identify this bot">Nombre descriptivo para identificar este bot</small>
                </div>

                <div class="form-group">
                    <label for="auto_api_key" data-lang-es="API Key de Binance" data-lang-en="Binance API Key">API Key de Binance</label>
                    <div style="position: relative;">
                        <input type="password" id="auto_api_key" placeholder="Tu API Key">
                        <button type="button" onclick="toggleAutoTokenVisibility('auto_api_key')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2em;">👁️</button>
                    </div>
                    <small data-lang-es="Opcional: Deja vacío para configurar después" data-lang-en="Optional: Leave empty to configure later">Opcional: Deja vacío para configurar después</small>
                </div>

                <div class="form-group">
                    <label for="auto_api_secret" data-lang-es="API Secret" data-lang-en="API Secret">API Secret</label>
                    <div style="position: relative;">
                        <input type="password" id="auto_api_secret" placeholder="Tu API Secret">
                        <button type="button" onclick="toggleAutoTokenVisibility('auto_api_secret')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2em;">👁️</button>
                    </div>
                    <small data-lang-es="Opcional: Deja vacío para configurar después" data-lang-en="Optional: Leave empty to configure later">Opcional: Deja vacío para configurar después</small>
                </div>

                <div class="grid-2" style="gap: 15px;">
                    <div class="form-group">
                        <label for="auto_modal_symbol" data-lang-es="Símbolo" data-lang-en="Symbol">Símbolo</label>
                        <input type="text" id="auto_modal_symbol" placeholder="BTCUSDT" required>
                    </div>

                    <div class="form-group">
                        <label for="auto_modal_timeframe" data-lang-es="Temporalidad" data-lang-en="Timeframe">Temporalidad</label>
                        <select id="auto_modal_timeframe">
                            <option value="1m" data-lang-es="1 minuto" data-lang-en="1 minute">1 minuto</option>
                            <option value="5m" data-lang-es="5 minutos" data-lang-en="5 minutes">5 minutos</option>
                            <option value="15m" selected data-lang-es="15 minutos" data-lang-en="15 minutes">15 minutos</option>
                            <option value="30m" data-lang-es="30 minutos" data-lang-en="30 minutes">30 minutos</option>
                            <option value="1h" data-lang-es="1 hora" data-lang-en="1 hour">1 hora</option>
                            <option value="4h" data-lang-es="4 horas" data-lang-en="4 hours">4 horas</option>
                            <option value="1d" data-lang-es="1 día" data-lang-en="1 day">1 día</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2" style="gap: 15px;">
                    <div class="form-group">
                        <label for="auto_position_size" data-lang-es="Tamaño de Posición (%)" data-lang-en="Position Size (%)">Tamaño de Posición (%)</label>
                        <input type="number" id="auto_position_size" value="10" min="1" max="100" step="1">
                    </div>

                    <div class="form-group">
                        <label for="auto_check_interval" data-lang-es="Intervalo de Verificación (segundos)" data-lang-en="Check Interval (seconds)">Intervalo de Verificación (segundos)</label>
                        <input type="number" id="auto_check_interval" value="60" min="10" max="3600" step="10">
                    </div>
                </div>

                <div class="grid-2" style="gap: 15px;">
                    <div class="form-group">
                        <label for="auto_stop_loss" data-lang-es="Stop Loss (%)" data-lang-en="Stop Loss (%)">Stop Loss (%)</label>
                        <input type="number" id="auto_stop_loss" value="2" min="0.1" max="20" step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="auto_take_profit" data-lang-es="Take Profit (%)" data-lang-en="Take Profit (%)">Take Profit (%)</label>
                        <input type="number" id="auto_take_profit" value="5" min="0.1" max="50" step="0.1">
                    </div>
                </div>

                <div class="form-group">
                    <label for="auto_trading_mode" data-lang-es="Modo de Trading" data-lang-en="Trading Mode">Modo de Trading</label>
                    <select id="auto_trading_mode">
                        <option value="testnet" data-lang-es="🧪 TestNet (Simulación)" data-lang-en="🧪 TestNet (Simulation)">🧪 TestNet (Simulación)</option>
                        <option value="live" data-lang-es="⚠️ LIVE (Real - Cuidado!)" data-lang-en="⚠️ LIVE (Real - Caution!)">⚠️ LIVE (Real - Cuidado!)</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAutoBotModal()" style="flex: 1;" data-lang-es="Cancelar" data-lang-en="Cancel">Cancelar</button>
                    <button type="submit" class="btn" style="flex: 1;" data-lang-es="💾 Guardar Bot" data-lang-en="💾 Save Bot">💾 Guardar Bot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Disclaimer de Auto Bot -->
    <div id="disclaimerModal" class="disclaimer-modal">
        <div class="disclaimer-content">
            <div class="disclaimer-header">
                <span class="disclaimer-icon">⚠️</span>
                <h3 data-lang-es="ADVERTENCIA IMPORTANTE: TRADING AUTOMÁTICO" data-lang-en="IMPORTANT WARNING: AUTOMATED TRADING">ADVERTENCIA IMPORTANTE: TRADING AUTOMÁTICO</h3>
            </div>
            
            <div class="disclaimer-text">
                <p data-lang-es="Antes de iniciar el bot de trading automático, es CRÍTICO que comprenda los siguientes riesgos:" 
                   data-lang-en="Before starting the automated trading bot, it is CRITICAL that you understand the following risks:">
                    Antes de iniciar el bot de trading automático, es CRÍTICO que comprenda los siguientes riesgos:
                </p>
                
                <ul class="disclaimer-list">
                    <li data-lang-es="El trading con dinero real conlleva RIESGO DE PÉRDIDA TOTAL del capital invertido" 
                        data-lang-en="Trading with real money carries RISK OF TOTAL LOSS of invested capital">
                        <strong>El trading con dinero real conlleva RIESGO DE PÉRDIDA TOTAL del capital invertido</strong>
                    </li>
                    <li data-lang-es="Los mercados de criptomonedas son extremadamente volátiles y pueden cambiar drásticamente" 
                        data-lang-en="Cryptocurrency markets are extremely volatile and can change drastically">
                        Los mercados de criptomonedas son extremadamente volátiles y pueden cambiar drásticamente
                    </li>
                    <li data-lang-es="Los fallos técnicos, errores de código o problemas de conexión pueden resultar en pérdidas" 
                        data-lang-en="Technical failures, code errors or connection problems can result in losses">
                        Los fallos técnicos, errores de código o problemas de conexión pueden resultar en pérdidas
                    </li>
                    <li data-lang-es="Las estrategias que funcionaron en backtest pueden fallar en condiciones reales del mercado" 
                        data-lang-en="Strategies that worked in backtest may fail in real market conditions">
                        Las estrategias que funcionaron en backtest pueden fallar en condiciones reales del mercado
                    </li>
                    <li data-lang-es="NUNCA invierta más dinero del que puede permitirse perder" 
                        data-lang-en="NEVER invest more money than you can afford to lose">
                        <strong>NUNCA invierta más dinero del que puede permitirse perder</strong>
                    </li>
                    <li data-lang-es="Este bot es una herramienta experimental y NO garantiza ganancias" 
                        data-lang-en="This bot is an experimental tool and does NOT guarantee profits">
                        <strong>Este bot es una herramienta experimental y NO garantiza ganancias</strong>
                    </li>
                    <li data-lang-es="Recomendamos ENCARECIDAMENTE probar primero en TestNet antes de usar dinero real" 
                        data-lang-en="We STRONGLY recommend testing on TestNet first before using real money">
                        <strong>Recomendamos ENCARECIDAMENTE probar primero en TestNet antes de usar dinero real</strong>
                    </li>
                </ul>

                <p data-lang-es="Este software se proporciona 'tal cual' sin garantía de ningún tipo. Usted es el único responsable de sus decisiones de trading." 
                   data-lang-en="This software is provided 'as is' without warranty of any kind. You are solely responsible for your trading decisions.">
                    <strong>Este software se proporciona 'tal cual' sin garantía de ningún tipo. Usted es el único responsable de sus decisiones de trading.</strong>
                </p>
            </div>

            <div class="disclaimer-checkbox">
                <input type="checkbox" id="disclaimerCheckbox">
                <label for="disclaimerCheckbox">
                    <span data-lang-es="He leído, comprendo y acepto TODOS los riesgos del trading automático con dinero real" 
                          data-lang-en="I have read, understand and accept ALL risks of automated trading with real money">
                        He leído, comprendo y acepto TODOS los riesgos del trading automático con dinero real
                    </span>
                </label>
            </div>

            <div class="disclaimer-buttons">
                <button id="cancelDisclaimerBtn" class="disclaimer-btn disclaimer-btn-cancel" 
                        data-lang-es="Cancelar" data-lang-en="Cancel">Cancelar</button>
                <button id="acceptDisclaimerBtn" class="disclaimer-btn disclaimer-btn-accept" disabled
                        data-lang-es="Aceptar y Continuar" data-lang-en="Accept and Continue">Aceptar y Continuar</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SCRIPT START - DEBUGGING ====================
        console.log('🚀 AUTO BOT SCRIPT LOADED');
        
        // ==================== CONSTRUCTION MODE CONTROL ====================
        let isAdmin = false;
        let constructionUnlocked = false;

        // Verificar si es administrador
        async function checkAdminStatus() {
            try {
                console.log('🔍 Checking admin status...');
                const response = await fetch('/api/user-info');
                console.log('📡 Response status:', response.status);
                
                const data = await response.json();
                console.log('📦 User data received:', data);
                console.log('👤 User object:', data.user);
                
                // Verificar si es admin usando el campo 'role'
                isAdmin = data.user?.role === 'admin' || data.is_admin === true;
                
                console.log('🎭 isAdmin value:', isAdmin);
                console.log('🔍 data.user.role:', data.user?.role);
                console.log('🔍 data.is_admin:', data.is_admin);
                
                const adminBtn = document.getElementById('adminAccessBtn');
                console.log('🔘 Admin button element:', adminBtn);
                
                if (isAdmin) {
                    // Mostrar botón de acceso para admin
                    if (adminBtn) {
                        adminBtn.style.display = 'inline-block';
                        console.log('✅ Admin button displayed');
                    } else {
                        console.error('❌ Admin button element not found!');
                    }
                    console.log('👑 Admin detected - Access button enabled');
                } else {
                    console.log('👤 Regular user - No admin access');
                }
            } catch (error) {
                console.error('❌ Error checking admin status:', error);
                isAdmin = false;
            }
        }

        // Desbloquear modo construcción (solo para admin)
        function unlockConstructionMode() {
            if (!isAdmin) {
                alert('⛔ Acceso denegado. Solo administradores pueden acceder.');
                return;
            }
            
            constructionUnlocked = true;
            const overlay = document.getElementById('constructionOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                console.log('🔓 Construction mode unlocked by admin');
            }, 300);
        }

        // ==================== GLOBAL VARIABLES ====================
        
        // Inicializar variables de AUTO BOT MANAGEMENT primero
        let userAutoBots = [];
        let autoBotIntervals = {};
        
        // Cargar desde localStorage inmediatamente
        try {
            const savedAutoBots = localStorage.getItem('userAutoBots');
            if (savedAutoBots) {
                userAutoBots = JSON.parse(savedAutoBots);
            }
        } catch (e) {
            console.error('Error cargando auto bots desde localStorage:', e);
            userAutoBots = [];
        }
        
        // ==================== STRATEGY BUILDER ====================
        
        let strategyConfig = {
            entry_long: [],
            exit_long: [],
            entry_short: [],
            exit_short: []
        };

        let blockCounter = 0;

        // Configuración del drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM Content Loaded');
            
            // Verificar estado de administrador primero
            console.log('🔧 Calling checkAdminStatus()...');
            checkAdminStatus();
            
            console.log('🎨 Initializing strategy builder...');
            initStrategyBuilder();
            updateStrategyInfo();
        });

        function initStrategyBuilder() {
            // Hacer bloques arrastrables
            const blocks = document.querySelectorAll('.block[draggable="true"]');
            blocks.forEach(block => {
                block.addEventListener('dragstart', handleDragStart);
                block.addEventListener('dragend', handleDragEnd);
            });

            // Configurar zonas de drop
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
        }

        function updateStrategyInfo() {
            // Validar que el elemento existe antes de actualizar
            const infoElement = document.getElementById('strategy_info');
            if (!infoElement) {
                console.log('Info element not found - strategy info display skipped');
                return; // Elemento no existe en esta página, salir silenciosamente
            }
            
            const totalBlocks = document.querySelectorAll('.dropped-block').length;
            const lang = localStorage.getItem('language') || 'en';
            
            if (totalBlocks === 0) {
                infoElement.innerHTML = lang === 'es' 
                    ? '❌ No configurada - Arrastra bloques en Sección 2'
                    : '❌ Not configured - Drag blocks in Section 2';
                infoElement.style.color = '#ff6b6b';
            } else {
                const zones = {
                    entry_long: document.querySelectorAll('[data-zone="entry_long"] .dropped-block').length,
                    exit_long: document.querySelectorAll('[data-zone="exit_long"] .dropped-block').length,
                    entry_short: document.querySelectorAll('[data-zone="entry_short"] .dropped-block').length,
                    exit_short: document.querySelectorAll('[data-zone="exit_short"] .dropped-block').length
                };
                
                // Traducir estrategia a lenguaje humano
                const strategyText = translateStrategyToHuman(lang);
                
                if (lang === 'es') {
                    infoElement.innerHTML = `
                        ✅ Configurada con ${totalBlocks} bloques<br>
                        <small style="opacity: 0.8;">
                            Entrada LONG: ${zones.entry_long} | Salida LONG: ${zones.exit_long}<br>
                            Entrada SHORT: ${zones.entry_short} | Salida SHORT: ${zones.exit_short}
                        </small>
                        ${strategyText ? '<br><br>' + strategyText : ''}
                    `;
                } else {
                    infoElement.innerHTML = `
                        ✅ Configured with ${totalBlocks} blocks<br>
                        <small style="opacity: 0.8;">
                            LONG Entry: ${zones.entry_long} | LONG Exit: ${zones.exit_long}<br>
                            SHORT Entry: ${zones.entry_short} | SHORT Exit: ${zones.exit_short}
                        </small>
                        ${strategyText ? '<br><br>' + strategyText : ''}
                    `;
                }
                infoElement.style.color = '#4caf50';
            }
        }
        
        function translateStrategyToHuman(lang) {
            const zones = [
                { id: 'entry_long_zone', label: lang === 'es' ? '📈 Entrada LONG' : '📈 LONG Entry' },
                { id: 'exit_long_zone', label: lang === 'es' ? '🚪 Salida LONG' : '🚪 LONG Exit' },
                { id: 'entry_short_zone', label: lang === 'es' ? '📉 Entrada SHORT' : '📉 SHORT Entry' },
                { id: 'exit_short_zone', label: lang === 'es' ? '🔚 Salida SHORT' : '🔚 SHORT Exit' }
            ];
            
            let html = '<div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); border-radius: 6px; border-left: 3px solid #667eea;">';
            html += `<strong style="color: #764ba2;">${lang === 'es' ? '🔍 Traducción de Estrategia:' : '🔍 Strategy Translation:'}</strong><br>`;
            
            let hasConditions = false;
            zones.forEach(zone => {
                const zoneElement = document.getElementById(zone.id);
                if (!zoneElement) return;
                
                const blocks = zoneElement.querySelectorAll('.dropped-block');
                if (blocks.length === 0) return;
                
                hasConditions = true;
                html += `<br><strong style="color: #667eea;">${zone.label}:</strong><br>`;
                
                blocks.forEach((block, index) => {
                    const blockName = block.dataset.name;
                    const blockType = block.dataset.type;
                    const description = getBlockDescription(blockName, blockType, block, lang);
                    html += `${index + 1}. ${description}<br>`;
                });
            });
            
            html += '</div>';
            return hasConditions ? html : '';
        }
        
        function getBlockDescription(name, type, blockElement, lang) {
            const translations = {
                es: {
                    EMA: 'Media Móvil Exponencial',
                    SMA: 'Media Móvil Simple',
                    RSI: 'Índice de Fuerza Relativa',
                    MACD: 'MACD (Convergencia/Divergencia)',
                    BBands: 'Bandas de Bollinger',
                    ATR: 'Rango Verdadero Promedio',
                    Swing: 'Swing High/Low',
                    Price: 'Precio actual',
                    Number: 'Número',
                    Percentage: 'Porcentaje',
                    GreaterThan: 'Mayor que',
                    LessThan: 'Menor que',
                    GreaterOrEqual: 'Mayor o igual que',
                    LessOrEqual: 'Menor o igual que',
                    Equal: 'Igual a',
                    NotEqual: 'Diferente de',
                    Crosses: 'Cruza',
                    AND: 'Y (ambas condiciones)',
                    OR: 'O (cualquiera)',
                    NOT: 'NO (niega condición)',
                    XOR: 'XOR (solo una)',
                    NAND: 'NAND (no ambas)',
                    NOR: 'NOR (ninguna)'
                },
                en: {
                    EMA: 'Exponential Moving Average',
                    SMA: 'Simple Moving Average',
                    RSI: 'Relative Strength Index',
                    MACD: 'MACD (Convergence/Divergence)',
                    BBands: 'Bollinger Bands',
                    ATR: 'Average True Range',
                    Swing: 'Swing High/Low',
                    Price: 'Current price',
                    Number: 'Number',
                    Percentage: 'Percentage',
                    GreaterThan: 'Greater than',
                    LessThan: 'Less than',
                    GreaterOrEqual: 'Greater or equal to',
                    LessOrEqual: 'Less or equal to',
                    Equal: 'Equal to',
                    NotEqual: 'Different from',
                    Crosses: 'Crosses',
                    AND: 'AND (both conditions)',
                    OR: 'OR (any condition)',
                    NOT: 'NOT (negates condition)',
                    XOR: 'XOR (only one)',
                    NAND: 'NAND (not both)',
                    NOR: 'NOR (neither)'
                }
            };
            
            const dict = translations[lang];
            let desc = dict[name] || name;
            
            // Agregar parámetros si existen
            const inputs = blockElement.querySelectorAll('input, select');
            if (inputs.length > 0) {
                const params = [];
                inputs.forEach(input => {
                    if (input.value) {
                        params.push(input.value);
                    }
                });
                if (params.length > 0) {
                    desc += ` (${params.join(', ')})`;
                }
            }
            
            return desc;
        }

        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: this.dataset.type,
                name: this.dataset.name,
                html: this.outerHTML
            }));
            
            // Ocultar paleta después de un pequeño delay
            setTimeout(() => {
                document.querySelector('.blocks-palette').classList.add('dragging');
                document.querySelector('.builder-canvas').classList.add('dragging-active');
                
                // Hacer scroll al canvas para que las cajas sean visibles
                const canvas = document.querySelector('.builder-canvas');
                if (canvas) {
                    canvas.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }
        
        function handleDragEnd(e) {
            // Mostrar paleta nuevamente
            document.querySelector('.blocks-palette').classList.remove('dragging');
            document.querySelector('.builder-canvas').classList.remove('dragging-active');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const zone = this.dataset.zone;
            
            addBlockToZone(zone, data);
        }

        function addBlockToZone(zone, blockData) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            
            // Remover mensaje vacío
            const emptyMsg = contentElement.querySelector('.drop-zone-empty');
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            const blockId = `block_${blockCounter++}`;
            
            // Crear el bloque dropped
            const droppedBlock = document.createElement('div');
            droppedBlock.className = 'dropped-block';
            droppedBlock.dataset.blockId = blockId;
            droppedBlock.dataset.type = blockData.type;
            droppedBlock.dataset.name = blockData.name;
            
            let paramsHtml = '';
            
            // Generar inputs según el tipo de bloque
            if (blockData.name === 'EMA' || blockData.name === 'SMA') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="50" min="1" max="200" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'RSI') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'MACD') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Rápido</label>
                            <input type="number" id="${blockId}_fast" value="12" min="2" max="50" step="1">
                        </div>
                        <div class="param-group">
                            <label>Lento</label>
                            <input type="number" id="${blockId}_slow" value="26" min="2" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Señal</label>
                            <input type="number" id="${blockId}_signal" value="9" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'BBands') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="20" min="5" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Desv. Std</label>
                            <input type="number" id="${blockId}_std" value="2" min="0.5" max="5" step="0.1">
                        </div>
                        <div class="param-group">
                            <label>Banda</label>
                            <select id="${blockId}_band">
                                <option value="upper">Superior</option>
                                <option value="middle">Media</option>
                                <option value="lower">Inferior</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'ATR') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Swing') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Tipo</label>
                            <select id="${blockId}_type">
                                <option value="high">High</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label>Lookback</label>
                            <input type="number" id="${blockId}_lookback" value="20" min="5" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Number') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Valor</label>
                            <input type="number" id="${blockId}_value" value="0" step="0.01">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Percentage') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Porcentaje (%)</label>
                            <input type="number" id="${blockId}_value" value="1" min="0" max="100" step="0.1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'GreaterThan' || blockData.name === 'LessThan' || blockData.name === 'GreaterOrEqual' || blockData.name === 'LessOrEqual' || blockData.name === 'Equal' || blockData.name === 'NotEqual' || blockData.name === 'Crosses') {
                const symbol = blockData.name === 'GreaterThan' ? '>' : 
                             blockData.name === 'LessThan' ? '<' : 
                             blockData.name === 'GreaterOrEqual' ? '≥' : 
                             blockData.name === 'LessOrEqual' ? '≤' : 
                             blockData.name === 'Equal' ? '=' : 
                             blockData.name === 'NotEqual' ? '≠' : '✖';
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Comparar</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="text" id="${blockId}_left" placeholder="ej: price, ema50" style="flex: 1;">
                                <span style="font-weight: bold;">${symbol}</span>
                                <input type="text" id="${blockId}_right" placeholder="ej: ema50, swing" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            droppedBlock.innerHTML = `
                <div class="dropped-block-header">
                    <div class="dropped-block-title">
                        ${getBlockIcon(blockData.name)}
                        <span>${getBlockLabel(blockData.name)}</span>
                    </div>
                    <div class="block-actions">
                        <button class="move-block" onclick="moveBlockUp('${blockId}', '${zone}')" title="Mover arriba">▲</button>
                        <button class="move-block" onclick="moveBlockDown('${blockId}', '${zone}')" title="Mover abajo">▼</button>
                        <button class="remove-block" onclick="removeBlock('${blockId}', '${zone}')">✕</button>
                    </div>
                </div>
                ${paramsHtml}
            `;
            
            contentElement.appendChild(droppedBlock);
            
            // Guardar en configuración
            strategyConfig[zone].push({
                id: blockId,
                type: blockData.type,
                name: blockData.name
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zone);
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function removeBlock(blockId, zone) {
            const block = document.querySelector(`[data-block-id="${blockId}"]`);
            if (block) {
                block.remove();
            }
            
            // Remover de configuración
            strategyConfig[zone] = strategyConfig[zone].filter(b => b.id !== blockId);
            
            // Si la zona quedó vacía, mostrar mensaje
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            if (contentElement.children.length === 0) {
                const lang = localStorage.getItem('language') || 'en';
                const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
                contentElement.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            } else {
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
            }
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function moveBlockUp(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex > 0) {
                // Intercambiar con el bloque anterior
                const previousBlock = blocks[currentIndex - 1];
                contentElement.insertBefore(blockElement, previousBlock);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex - 1];
                strategyConfig[zone][currentIndex - 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function moveBlockDown(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex < blocks.length - 1) {
                // Intercambiar con el bloque siguiente
                const nextBlock = blocks[currentIndex + 1];
                contentElement.insertBefore(nextBlock, blockElement);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex + 1];
                strategyConfig[zone][currentIndex + 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function updateMoveButtons(zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            
            blocks.forEach((block, index) => {
                const upButton = block.querySelector('.move-block:nth-of-type(1)');
                const downButton = block.querySelector('.move-block:nth-of-type(2)');
                
                if (upButton) {
                    upButton.disabled = (index === 0);
                }
                if (downButton) {
                    downButton.disabled = (index === blocks.length - 1);
                }
            });
        }

        function clearStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            const confirmMsg = lang === 'es' 
                ? '¿Estás seguro de limpiar toda la estrategia?' 
                : 'Are you sure you want to clear the entire strategy?';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function exportStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            
            // Recolectar todos los bloques de cada zona
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            // Validar que hay al menos una estrategia
            const hasBlocks = strategy.entry_long.length > 0 || 
                             strategy.exit_long.length > 0 || 
                             strategy.entry_short.length > 0 || 
                             strategy.exit_short.length > 0;
            
            if (!hasBlocks) {
                const msg = lang === 'es' 
                    ? 'No hay estrategia para exportar. Arrastra bloques primero.'
                    : 'No strategy to export. Drag blocks first.';
                alert(msg);
                return;
            }
            
            // Crear archivo JSON
            const dataStr = JSON.stringify(strategy, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Descargar archivo
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `strategy_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            const successMsg = lang === 'es'
                ? '✅ Estrategia exportada exitosamente!'
                : '✅ Strategy exported successfully!';
            alert(successMsg);
        }
        
        function extractBlocksFromZone(zoneId) {
            const zone = document.getElementById(zoneId);
            if (!zone) {
                console.warn(`Zone not found: ${zoneId}`);
                return [];
            }
            
            const blocks = [];
            const blockElements = zone.querySelectorAll('.dropped-block');
            
            blockElements.forEach(block => {
                const blockData = {
                    type: block.dataset.type,
                    name: block.dataset.name,
                    params: {}
                };
                
                // Extraer valores de parámetros
                const inputs = block.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.id) {
                        blockData.params[input.id] = input.value;
                    }
                });
                
                blocks.push(blockData);
            });
            
            return blocks;
        }
        
        function importStrategy(event) {
            const lang = localStorage.getItem('language') || 'en';
            const file = event.target.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const strategy = JSON.parse(e.target.result);
                
                // Validar estructura básica
                if (!strategy.version || !strategy.entry_long) {
                    const errorMsg = lang === 'es'
                        ? '❌ Error al importar estrategia. Verifica que el archivo sea válido.'
                        : '❌ Error importing strategy. Verify the file is valid.';
                    alert(errorMsg);
                    return;
                }
                
                // Limpiar estrategia actual
                clearStrategyWithoutConfirm();
                
                // Cargar bloques en cada zona
                loadBlocksToZone('entry_long_zone', strategy.entry_long);
                loadBlocksToZone('exit_long_zone', strategy.exit_long);
                loadBlocksToZone('entry_short_zone', strategy.entry_short);
                loadBlocksToZone('exit_short_zone', strategy.exit_short);
                
                // Actualizar información de estrategia
                updateStrategyInfo();
                
                const successMsg = lang === 'es'
                    ? '✅ Estrategia importada exitosamente!'
                    : '✅ Strategy imported successfully!';
                alert(successMsg);
            };
            
            reader.readAsText(file);
            
            // Reset input para permitir reimportar el mismo archivo
            event.target.value = '';
        }
        
        function clearStrategyWithoutConfirm() {
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const lang = localStorage.getItem('language') || 'en';
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }
        
        function loadBlocksToZone(zoneId, blocks) {
            if (!blocks || blocks.length === 0) return;
            
            const zone = document.getElementById(zoneId);
            if (!zone) return;
            
            const zoneName = zone.dataset.zone;
            if (!zoneName) return;
            
            // Limpiar configuración de esta zona
            strategyConfig[zoneName] = [];
            
            // Agregar cada bloque usando la misma función que cuando se arrastra
            blocks.forEach((blockData) => {
                // Recrear el bloque con sus parámetros guardados
                const blockToAdd = {
                    type: blockData.type,
                    name: blockData.name,
                    params: blockData.params
                };
                
                addBlockToZone(zoneName, blockToAdd);
                
                // Ahora actualizar los valores de los parámetros después de crear el bloque
                if (blockData.params) {
                    // Obtener el último bloque agregado
                    const droppedBlocks = zone.querySelectorAll('.dropped-block');
                    const lastBlock = droppedBlocks[droppedBlocks.length - 1];
                    
                    if (lastBlock) {
                        // Aplicar los valores guardados a los inputs
                        Object.entries(blockData.params).forEach(([paramId, paramValue]) => {
                            const input = lastBlock.querySelector(`#${paramId}`);
                            if (input) {
                                input.value = paramValue;
                            } else {
                                // Si el ID exacto no existe, buscar por el sufijo del parámetro
                                const paramSuffix = paramId.split('_').pop();
                                const inputBySuffix = lastBlock.querySelector(`[id$="_${paramSuffix}"]`);
                                if (inputBySuffix) {
                                    inputBySuffix.value = paramValue;
                                }
                            }
                        });
                    }
                }
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zoneId);
        }

        function getBlockIcon(name) {
            const icons = {
                'EMA': '📊',
                'SMA': '📈',
                'RSI': '⚡',
                'MACD': '🌊',
                'BBands': '📏',
                'ATR': '📊',
                'Swing': '🔄',
                'Price': '💵',
                'Number': '🔢',
                'Percentage': '📊',
                'GreaterThan': '>',
                'LessThan': '<',
                'GreaterOrEqual': '≥',
                'LessOrEqual': '≤',
                'Equal': '=',
                'NotEqual': '≠',
                'Crosses': '✖️',
                'AND': '∧',
                'OR': '∨',
                'NOT': '¬',
                'XOR': '⊕',
                'NAND': '⊼',
                'NOR': '⊽'
            };
            return icons[name] || '📦';
        }

        function getBlockLabel(name) {
            const labels = {
                'EMA': 'EMA',
                'SMA': 'SMA',
                'RSI': 'RSI',
                'MACD': 'MACD',
                'BBands': 'Bollinger',
                'ATR': 'ATR',
                'Swing': 'Swing',
                'Price': 'Precio',
                'Number': 'Número',
                'Percentage': 'Porcentaje',
                'GreaterThan': 'Mayor que',
                'LessThan': 'Menor que',
                'GreaterOrEqual': 'Mayor/Igual',
                'LessOrEqual': 'Menor/Igual',
                'Equal': 'Igual',
                'NotEqual': 'Diferente',
                'Crosses': 'Cruza',
                'AND': 'AND',
                'OR': 'OR',
                'NOT': 'NOT',
                'XOR': 'XOR',
                'NAND': 'NAND',
                'NOR': 'NOR'
            };
            return labels[name] || name;
        }

        function getStrategyParams() {
            // Extraer parámetros de todos los bloques
            const params = {
                indicators: [],
                conditions: {}
            };
            
            // Buscar bloques EMA - solo si existen
            const emaBlocks = document.querySelectorAll('.dropped-block[data-name="EMA"]');
            if (emaBlocks.length > 0) {
                const firstEMA = emaBlocks[0].querySelector('[id$="_period"]');
                if (firstEMA && firstEMA.value) {
                    params.ema_period = parseInt(firstEMA.value);
                }
            }
            
            // Buscar bloques Swing - solo si existen
            const swingBlocks = document.querySelectorAll('.dropped-block[data-name="Swing"]');
            if (swingBlocks.length > 0) {
                const firstSwing = swingBlocks[0].querySelector('[id$="_lookback"]');
                if (firstSwing && firstSwing.value) {
                    params.swing_lookback = parseInt(firstSwing.value);
                }
            }
            
            // Recopilar todos los indicadores configurados
            document.querySelectorAll('.dropped-block[data-type="indicator"]').forEach(block => {
                const indicator = {
                    type: block.dataset.name,
                    params: {}
                };
                
                // Extraer parámetros específicos
                block.querySelectorAll('input, select').forEach(input => {
                    const paramName = input.id.split('_').pop();
                    indicator.params[paramName] = input.value;
                });
                
                params.indicators.push(indicator);
            });
            
            return params;
        }
        
        function getFullStrategyData() {
            // Recolectar todos los bloques de cada zona para enviar al backend
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            return strategy;
        }

        // initStrategyBuilder ya está definida arriba - NO DUPLICAR
        // updateStrategyInfo ya está definida arriba - NO DUPLICAR
        
        function translateStrategyToHuman(lang) {
            const zones = [
                { id: 'entry_long_zone', label: lang === 'es' ? '📈 Entrada LONG' : '📈 LONG Entry' },
                { id: 'exit_long_zone', label: lang === 'es' ? '🚪 Salida LONG' : '🚪 LONG Exit' },
                { id: 'entry_short_zone', label: lang === 'es' ? '📉 Entrada SHORT' : '📉 SHORT Entry' },
                { id: 'exit_short_zone', label: lang === 'es' ? '🔚 Salida SHORT' : '🔚 SHORT Exit' }
            ];
            
            let html = '<div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); border-radius: 6px; border-left: 3px solid #667eea;">';
            html += `<strong style="color: #764ba2;">${lang === 'es' ? '🔍 Traducción de Estrategia:' : '🔍 Strategy Translation:'}</strong><br>`;
            
            let hasConditions = false;
            zones.forEach(zone => {
                const zoneElement = document.getElementById(zone.id);
                if (!zoneElement) return;
                
                const blocks = zoneElement.querySelectorAll('.dropped-block');
                if (blocks.length === 0) return;
                
                hasConditions = true;
                html += `<br><strong style="color: #667eea;">${zone.label}:</strong><br>`;
                
                blocks.forEach((block, index) => {
                    const blockName = block.dataset.name;
                    const blockType = block.dataset.type;
                    const description = getBlockDescription(blockName, blockType, block, lang);
                    html += `${index + 1}. ${description}<br>`;
                });
            });
            
            html += '</div>';
            return hasConditions ? html : '';
        }
        
        function getBlockDescription(name, type, blockElement, lang) {
            const translations = {
                es: {
                    EMA: 'Media Móvil Exponencial',
                    SMA: 'Media Móvil Simple',
                    RSI: 'Índice de Fuerza Relativa',
                    MACD: 'MACD (Convergencia/Divergencia)',
                    BBands: 'Bandas de Bollinger',
                    ATR: 'Rango Verdadero Promedio',
                    Swing: 'Swing High/Low',
                    Price: 'Precio actual',
                    Number: 'Número',
                    Percentage: 'Porcentaje',
                    GreaterThan: 'Mayor que',
                    LessThan: 'Menor que',
                    GreaterOrEqual: 'Mayor o igual que',
                    LessOrEqual: 'Menor o igual que',
                    Equal: 'Igual a',
                    NotEqual: 'Diferente de',
                    Crosses: 'Cruza',
                    AND: 'Y (ambas condiciones)',
                    OR: 'O (cualquiera)',
                    NOT: 'NO (niega condición)',
                    XOR: 'XOR (solo una)',
                    NAND: 'NAND (no ambas)',
                    NOR: 'NOR (ninguna)'
                },
                en: {
                    EMA: 'Exponential Moving Average',
                    SMA: 'Simple Moving Average',
                    RSI: 'Relative Strength Index',
                    MACD: 'MACD (Convergence/Divergence)',
                    BBands: 'Bollinger Bands',
                    ATR: 'Average True Range',
                    Swing: 'Swing High/Low',
                    Price: 'Current price',
                    Number: 'Number',
                    Percentage: 'Percentage',
                    GreaterThan: 'Greater than',
                    LessThan: 'Less than',
                    GreaterOrEqual: 'Greater or equal to',
                    LessOrEqual: 'Less or equal to',
                    Equal: 'Equal to',
                    NotEqual: 'Different from',
                    Crosses: 'Crosses',
                    AND: 'AND (both conditions)',
                    OR: 'OR (any condition)',
                    NOT: 'NOT (negates condition)',
                    XOR: 'XOR (only one)',
                    NAND: 'NAND (not both)',
                    NOR: 'NOR (neither)'
                }
            };
            
            const dict = translations[lang];
            let desc = dict[name] || name;
            
            // Agregar parámetros si existen
            const inputs = blockElement.querySelectorAll('input, select');
            if (inputs.length > 0) {
                const params = [];
                inputs.forEach(input => {
                    if (input.value) {
                        params.push(input.value);
                    }
                });
                if (params.length > 0) {
                    desc += ` (${params.join(', ')})`;
                }
            }
            
            return desc;
        }

        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: this.dataset.type,
                name: this.dataset.name,
                html: this.outerHTML
            }));
            
            // Ocultar paleta después de un pequeño delay
            setTimeout(() => {
                document.querySelector('.blocks-palette').classList.add('dragging');
                document.querySelector('.builder-canvas').classList.add('dragging-active');
                
                // Hacer scroll al canvas para que las cajas sean visibles
                const canvas = document.querySelector('.builder-canvas');
                if (canvas) {
                    canvas.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }
        
        function handleDragEnd(e) {
            // Mostrar paleta nuevamente
            document.querySelector('.blocks-palette').classList.remove('dragging');
            document.querySelector('.builder-canvas').classList.remove('dragging-active');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const zone = this.dataset.zone;
            
            addBlockToZone(zone, data);
        }

        function addBlockToZone(zone, blockData) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            
            // Remover mensaje vacío
            const emptyMsg = contentElement.querySelector('.drop-zone-empty');
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            const blockId = `block_${blockCounter++}`;
            
            // Crear el bloque dropped
            const droppedBlock = document.createElement('div');
            droppedBlock.className = 'dropped-block';
            droppedBlock.dataset.blockId = blockId;
            droppedBlock.dataset.type = blockData.type;
            droppedBlock.dataset.name = blockData.name;
            
            let paramsHtml = '';
            
            // Generar inputs según el tipo de bloque
            if (blockData.name === 'EMA' || blockData.name === 'SMA') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="50" min="1" max="200" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'RSI') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'MACD') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Rápido</label>
                            <input type="number" id="${blockId}_fast" value="12" min="2" max="50" step="1">
                        </div>
                        <div class="param-group">
                            <label>Lento</label>
                            <input type="number" id="${blockId}_slow" value="26" min="2" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Señal</label>
                            <input type="number" id="${blockId}_signal" value="9" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'BBands') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="20" min="5" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Desv. Std</label>
                            <input type="number" id="${blockId}_std" value="2" min="0.5" max="5" step="0.1">
                        </div>
                        <div class="param-group">
                            <label>Banda</label>
                            <select id="${blockId}_band">
                                <option value="upper">Superior</option>
                                <option value="middle">Media</option>
                                <option value="lower">Inferior</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'ATR') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Swing') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Tipo</label>
                            <select id="${blockId}_type">
                                <option value="high">High</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label>Lookback</label>
                            <input type="number" id="${blockId}_lookback" value="20" min="5" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Number') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Valor</label>
                            <input type="number" id="${blockId}_value" value="0" step="0.01">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Percentage') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Porcentaje (%)</label>
                            <input type="number" id="${blockId}_value" value="1" min="0" max="100" step="0.1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'GreaterThan' || blockData.name === 'LessThan' || blockData.name === 'GreaterOrEqual' || blockData.name === 'LessOrEqual' || blockData.name === 'Equal' || blockData.name === 'NotEqual' || blockData.name === 'Crosses') {
                const symbol = blockData.name === 'GreaterThan' ? '>' : 
                             blockData.name === 'LessThan' ? '<' : 
                             blockData.name === 'GreaterOrEqual' ? '≥' : 
                             blockData.name === 'LessOrEqual' ? '≤' : 
                             blockData.name === 'Equal' ? '=' : 
                             blockData.name === 'NotEqual' ? '≠' : '✖';
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Comparar</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="text" id="${blockId}_left" placeholder="ej: price, ema50" style="flex: 1;">
                                <span style="font-weight: bold;">${symbol}</span>
                                <input type="text" id="${blockId}_right" placeholder="ej: ema50, swing" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            droppedBlock.innerHTML = `
                <div class="dropped-block-header">
                    <div class="dropped-block-title">
                        ${getBlockIcon(blockData.name)}
                        <span>${getBlockLabel(blockData.name)}</span>
                    </div>
                    <div class="block-actions">
                        <button class="move-block" onclick="moveBlockUp('${blockId}', '${zone}')" title="Mover arriba">▲</button>
                        <button class="move-block" onclick="moveBlockDown('${blockId}', '${zone}')" title="Mover abajo">▼</button>
                        <button class="remove-block" onclick="removeBlock('${blockId}', '${zone}')">✕</button>
                    </div>
                </div>
                ${paramsHtml}
            `;
            
            contentElement.appendChild(droppedBlock);
            
            // Guardar en configuración
            strategyConfig[zone].push({
                id: blockId,
                type: blockData.type,
                name: blockData.name
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zone);
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function removeBlock(blockId, zone) {
            const block = document.querySelector(`[data-block-id="${blockId}"]`);
            if (block) {
                block.remove();
            }
            
            // Remover de configuración
            strategyConfig[zone] = strategyConfig[zone].filter(b => b.id !== blockId);
            
            // Si la zona quedó vacía, mostrar mensaje
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            if (contentElement.children.length === 0) {
                const lang = localStorage.getItem('language') || 'en';
                const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
                contentElement.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            } else {
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
            }
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function moveBlockUp(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex > 0) {
                // Intercambiar con el bloque anterior
                const previousBlock = blocks[currentIndex - 1];
                contentElement.insertBefore(blockElement, previousBlock);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex - 1];
                strategyConfig[zone][currentIndex - 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function moveBlockDown(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex < blocks.length - 1) {
                // Intercambiar con el bloque siguiente
                const nextBlock = blocks[currentIndex + 1];
                contentElement.insertBefore(nextBlock, blockElement);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex + 1];
                strategyConfig[zone][currentIndex + 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function updateMoveButtons(zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            
            blocks.forEach((block, index) => {
                const upButton = block.querySelector('.move-block:nth-of-type(1)');
                const downButton = block.querySelector('.move-block:nth-of-type(2)');
                
                if (upButton) {
                    upButton.disabled = (index === 0);
                }
                if (downButton) {
                    downButton.disabled = (index === blocks.length - 1);
                }
            });
        }

        function clearStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            const confirmMsg = lang === 'es' 
                ? '¿Estás seguro de limpiar toda la estrategia?' 
                : 'Are you sure you want to clear the entire strategy?';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function exportStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            
            // Recolectar todos los bloques de cada zona
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            // Validar que hay al menos una estrategia
            const hasBlocks = strategy.entry_long.length > 0 || 
                             strategy.exit_long.length > 0 || 
                             strategy.entry_short.length > 0 || 
                             strategy.exit_short.length > 0;
            
            if (!hasBlocks) {
                const msg = lang === 'es' 
                    ? 'No hay estrategia para exportar. Arrastra bloques primero.'
                    : 'No strategy to export. Drag blocks first.';
                alert(msg);
                return;
            }
            
            // Crear archivo JSON
            const dataStr = JSON.stringify(strategy, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Descargar archivo
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `strategy_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            const successMsg = lang === 'es'
                ? '✅ Estrategia exportada exitosamente!'
                : '✅ Strategy exported successfully!';
            alert(successMsg);
        }
        
        function extractBlocksFromZone(zoneId) {
            const zone = document.getElementById(zoneId);
            if (!zone) {
                console.warn(`Zone not found: ${zoneId}`);
                return [];
            }
            
            const blocks = [];
            const blockElements = zone.querySelectorAll('.dropped-block');
            
            blockElements.forEach(block => {
                const blockData = {
                    type: block.dataset.type,
                    name: block.dataset.name,
                    params: {}
                };
                
                // Extraer valores de parámetros
                const inputs = block.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.id) {
                        blockData.params[input.id] = input.value;
                    }
                });
                
                blocks.push(blockData);
            });
            
            return blocks;
        }
        
        function importStrategy(event) {
            const lang = localStorage.getItem('language') || 'en';
            const file = event.target.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const strategy = JSON.parse(e.target.result);
                
                // Validar estructura básica
                if (!strategy.version || !strategy.entry_long) {
                    const errorMsg = lang === 'es'
                        ? '❌ Error al importar estrategia. Verifica que el archivo sea válido.'
                        : '❌ Error importing strategy. Verify the file is valid.';
                    alert(errorMsg);
                    return;
                }
                
                // Limpiar estrategia actual
                clearStrategyWithoutConfirm();
                
                // Cargar bloques en cada zona
                loadBlocksToZone('entry_long_zone', strategy.entry_long);
                loadBlocksToZone('exit_long_zone', strategy.exit_long);
                loadBlocksToZone('entry_short_zone', strategy.entry_short);
                loadBlocksToZone('exit_short_zone', strategy.exit_short);
                
                // Actualizar información de estrategia
                updateStrategyInfo();
                
                const successMsg = lang === 'es'
                    ? '✅ Estrategia importada exitosamente!'
                    : '✅ Strategy imported successfully!';
                alert(successMsg);
            };
            
            reader.readAsText(file);
            
            // Reset input para permitir reimportar el mismo archivo
            event.target.value = '';
        }
        
        function clearStrategyWithoutConfirm() {
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const lang = localStorage.getItem('language') || 'en';
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }
        
        function loadBlocksToZone(zoneId, blocks) {
            if (!blocks || blocks.length === 0) return;
            
            const zone = document.getElementById(zoneId);
            if (!zone) return;
            
            const zoneName = zone.dataset.zone;
            if (!zoneName) return;
            
            // Limpiar configuración de esta zona
            strategyConfig[zoneName] = [];
            
            // Agregar cada bloque usando la misma función que cuando se arrastra
            blocks.forEach((blockData) => {
                // Recrear el bloque con sus parámetros guardados
                const blockToAdd = {
                    type: blockData.type,
                    name: blockData.name,
                    params: blockData.params
                };
                
                addBlockToZone(zoneName, blockToAdd);
                
                // Ahora actualizar los valores de los parámetros después de crear el bloque
                if (blockData.params) {
                    // Obtener el último bloque agregado
                    const droppedBlocks = zone.querySelectorAll('.dropped-block');
                    const lastBlock = droppedBlocks[droppedBlocks.length - 1];
                    
                    if (lastBlock) {
                        // Aplicar los valores guardados a los inputs
                        Object.entries(blockData.params).forEach(([paramId, paramValue]) => {
                            const input = lastBlock.querySelector(`#${paramId}`);
                            if (input) {
                                input.value = paramValue;
                            } else {
                                // Si el ID exacto no existe, buscar por el sufijo del parámetro
                                const paramSuffix = paramId.split('_').pop();
                                const inputBySuffix = lastBlock.querySelector(`[id$="_${paramSuffix}"]`);
                                if (inputBySuffix) {
                                    inputBySuffix.value = paramValue;
                                }
                            }
                        });
                    }
                }
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zoneName);
        }

        function getBlockIcon(name) {
            const icons = {
                'EMA': '📊',
                'SMA': '📈',
                'RSI': '⚡',
                'MACD': '🌊',
                'BBands': '📏',
                'ATR': '📊',
                'Swing': '🔄',
                'Price': '💵',
                'Number': '🔢',
                'Percentage': '📊',
                'GreaterThan': '>',
                'LessThan': '<',
                'GreaterOrEqual': '≥',
                'LessOrEqual': '≤',
                'Equal': '=',
                'NotEqual': '≠',
                'Crosses': '✖️',
                'AND': '∧',
                'OR': '∨',
                'NOT': '¬',
                'XOR': '⊕',
                'NAND': '⊼',
                'NOR': '⊽'
            };
            return icons[name] || '📦';
        }

        function getBlockLabel(name) {
            const labels = {
                'EMA': 'EMA',
                'SMA': 'SMA',
                'RSI': 'RSI',
                'MACD': 'MACD',
                'BBands': 'Bollinger',
                'ATR': 'ATR',
                'Swing': 'Swing',
                'Price': 'Precio',
                'Number': 'Número',
                'Percentage': 'Porcentaje',
                'GreaterThan': 'Mayor que',
                'LessThan': 'Menor que',
                'GreaterOrEqual': 'Mayor/Igual',
                'LessOrEqual': 'Menor/Igual',
                'Equal': 'Igual',
                'NotEqual': 'Diferente',
                'Crosses': 'Cruza',
                'AND': 'AND',
                'OR': 'OR',
                'NOT': 'NOT',
                'XOR': 'XOR',
                'NAND': 'NAND',
                'NOR': 'NOR'
            };
            return labels[name] || name;
        }

        function getStrategyParams() {
            // Extraer parámetros de todos los bloques
            const params = {
                indicators: [],
                conditions: {}
            };
            
            // Buscar bloques EMA - solo si existen
            const emaBlocks = document.querySelectorAll('.dropped-block[data-name="EMA"]');
            if (emaBlocks.length > 0) {
                const firstEMA = emaBlocks[0].querySelector('[id$="_period"]');
                if (firstEMA && firstEMA.value) {
                    params.ema_period = parseInt(firstEMA.value);
                }
            }
            
            // Buscar bloques Swing - solo si existen
            const swingBlocks = document.querySelectorAll('.dropped-block[data-name="Swing"]');
            if (swingBlocks.length > 0) {
                const firstSwing = swingBlocks[0].querySelector('[id$="_lookback"]');
                if (firstSwing && firstSwing.value) {
                    params.swing_lookback = parseInt(firstSwing.value);
                }
            }
            
            // Recopilar todos los indicadores configurados
            document.querySelectorAll('.dropped-block[data-type="indicator"]').forEach(block => {
                const indicator = {
                    type: block.dataset.name,
                    params: {}
                };
                
                // Extraer parámetros específicos
                block.querySelectorAll('input, select').forEach(input => {
                    const paramName = input.id.split('_').pop();
                    indicator.params[paramName] = input.value;
                });
                
                params.indicators.push(indicator);
            });
            
            return params;
        }
        
        function getFullStrategyData() {
            // Recolectar todos los bloques de cada zona para enviar al backend
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            return strategy;
        }

        // initStrategyBuilder ya está definida arriba - NO DUPLICAR
        // updateStrategyInfo ya está definida arriba - NO DUPLICAR
        
        function translateStrategyToHuman(lang) {
            const zones = [
                { id: 'entry_long_zone', label: lang === 'es' ? '📈 Entrada LONG' : '📈 LONG Entry' },
                { id: 'exit_long_zone', label: lang === 'es' ? '🚪 Salida LONG' : '🚪 LONG Exit' },
                { id: 'entry_short_zone', label: lang === 'es' ? '📉 Entrada SHORT' : '📉 SHORT Entry' },
                { id: 'exit_short_zone', label: lang === 'es' ? '🔚 Salida SHORT' : '🔚 SHORT Exit' }
            ];
            
            let html = '<div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); border-radius: 6px; border-left: 3px solid #667eea;">';
            html += `<strong style="color: #764ba2;">${lang === 'es' ? '🔍 Traducción de Estrategia:' : '🔍 Strategy Translation:'}</strong><br>`;
            
            let hasConditions = false;
            zones.forEach(zone => {
                const zoneElement = document.getElementById(zone.id);
                if (!zoneElement) return;
                
                const blocks = zoneElement.querySelectorAll('.dropped-block');
                if (blocks.length === 0) return;
                
                hasConditions = true;
                html += `<br><strong style="color: #667eea;">${zone.label}:</strong><br>`;
                
                blocks.forEach((block, index) => {
                    const blockName = block.dataset.name;
                    const blockType = block.dataset.type;
                    const description = getBlockDescription(blockName, blockType, block, lang);
                    html += `${index + 1}. ${description}<br>`;
                });
            });
            
            html += '</div>';
            return hasConditions ? html : '';
        }
        
        function getBlockDescription(name, type, blockElement, lang) {
            const translations = {
                es: {
                    EMA: 'Media Móvil Exponencial',
                    SMA: 'Media Móvil Simple',
                    RSI: 'Índice de Fuerza Relativa',
                    MACD: 'MACD (Convergencia/Divergencia)',
                    BBands: 'Bandas de Bollinger',
                    ATR: 'Rango Verdadero Promedio',
                    Swing: 'Swing High/Low',
                    Price: 'Precio actual',
                    Number: 'Número',
                    Percentage: 'Porcentaje',
                    GreaterThan: 'Mayor que',
                    LessThan: 'Menor que',
                    GreaterOrEqual: 'Mayor o igual que',
                    LessOrEqual: 'Menor o igual que',
                    Equal: 'Igual a',
                    NotEqual: 'Diferente de',
                    Crosses: 'Cruza',
                    AND: 'Y (ambas condiciones)',
                    OR: 'O (cualquiera)',
                    NOT: 'NO (niega condición)',
                    XOR: 'XOR (solo una)',
                    NAND: 'NAND (no ambas)',
                    NOR: 'NOR (ninguna)'
                },
                en: {
                    EMA: 'Exponential Moving Average',
                    SMA: 'Simple Moving Average',
                    RSI: 'Relative Strength Index',
                    MACD: 'MACD (Convergence/Divergence)',
                    BBands: 'Bollinger Bands',
                    ATR: 'Average True Range',
                    Swing: 'Swing High/Low',
                    Price: 'Current price',
                    Number: 'Number',
                    Percentage: 'Percentage',
                    GreaterThan: 'Greater than',
                    LessThan: 'Less than',
                    GreaterOrEqual: 'Greater or equal to',
                    LessOrEqual: 'Less or equal to',
                    Equal: 'Equal to',
                    NotEqual: 'Different from',
                    Crosses: 'Crosses',
                    AND: 'AND (both conditions)',
                    OR: 'OR (any condition)',
                    NOT: 'NOT (negates condition)',
                    XOR: 'XOR (only one)',
                    NAND: 'NAND (not both)',
                    NOR: 'NOR (neither)'
                }
            };
            
            const dict = translations[lang];
            let desc = dict[name] || name;
            
            // Agregar parámetros si existen
            const inputs = blockElement.querySelectorAll('input, select');
            if (inputs.length > 0) {
                const params = [];
                inputs.forEach(input => {
                    if (input.value) {
                        params.push(input.value);
                    }
                });
                if (params.length > 0) {
                    desc += ` (${params.join(', ')})`;
                }
            }
            
            return desc;
        }

        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: this.dataset.type,
                name: this.dataset.name,
                html: this.outerHTML
            }));
            
            // Ocultar paleta después de un pequeño delay
            setTimeout(() => {
                document.querySelector('.blocks-palette').classList.add('dragging');
                document.querySelector('.builder-canvas').classList.add('dragging-active');
                
                // Hacer scroll al canvas para que las cajas sean visibles
                const canvas = document.querySelector('.builder-canvas');
                if (canvas) {
                    canvas.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }
        
        function handleDragEnd(e) {
            // Mostrar paleta nuevamente
            document.querySelector('.blocks-palette').classList.remove('dragging');
            document.querySelector('.builder-canvas').classList.remove('dragging-active');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const zone = this.dataset.zone;
            
            addBlockToZone(zone, data);
        }

        function addBlockToZone(zone, blockData) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            
            // Remover mensaje vacío
            const emptyMsg = contentElement.querySelector('.drop-zone-empty');
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            const blockId = `block_${blockCounter++}`;
            
            // Crear el bloque dropped
            const droppedBlock = document.createElement('div');
            droppedBlock.className = 'dropped-block';
            droppedBlock.dataset.blockId = blockId;
            droppedBlock.dataset.type = blockData.type;
            droppedBlock.dataset.name = blockData.name;
            
            let paramsHtml = '';
            
            // Generar inputs según el tipo de bloque
            if (blockData.name === 'EMA' || blockData.name === 'SMA') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="50" min="1" max="200" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'RSI') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'MACD') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Rápido</label>
                            <input type="number" id="${blockId}_fast" value="12" min="2" max="50" step="1">
                        </div>
                        <div class="param-group">
                            <label>Lento</label>
                            <input type="number" id="${blockId}_slow" value="26" min="2" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Señal</label>
                            <input type="number" id="${blockId}_signal" value="9" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'BBands') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="20" min="5" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Desv. Std</label>
                            <input type="number" id="${blockId}_std" value="2" min="0.5" max="5" step="0.1">
                        </div>
                        <div class="param-group">
                            <label>Banda</label>
                            <select id="${blockId}_band">
                                <option value="upper">Superior</option>
                                <option value="middle">Media</option>
                                <option value="lower">Inferior</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'ATR') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Swing') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Tipo</label>
                            <select id="${blockId}_type">
                                <option value="high">High</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label>Lookback</label>
                            <input type="number" id="${blockId}_lookback" value="20" min="5" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Number') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Valor</label>
                            <input type="number" id="${blockId}_value" value="0" step="0.01">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Percentage') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Porcentaje (%)</label>
                            <input type="number" id="${blockId}_value" value="1" min="0" max="100" step="0.1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'GreaterThan' || blockData.name === 'LessThan' || blockData.name === 'GreaterOrEqual' || blockData.name === 'LessOrEqual' || blockData.name === 'Equal' || blockData.name === 'NotEqual' || blockData.name === 'Crosses') {
                const symbol = blockData.name === 'GreaterThan' ? '>' : 
                             blockData.name === 'LessThan' ? '<' : 
                             blockData.name === 'GreaterOrEqual' ? '≥' : 
                             blockData.name === 'LessOrEqual' ? '≤' : 
                             blockData.name === 'Equal' ? '=' : 
                             blockData.name === 'NotEqual' ? '≠' : '✖';
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Comparar</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="text" id="${blockId}_left" placeholder="ej: price, ema50" style="flex: 1;">
                                <span style="font-weight: bold;">${symbol}</span>
                                <input type="text" id="${blockId}_right" placeholder="ej: ema50, swing" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            droppedBlock.innerHTML = `
                <div class="dropped-block-header">
                    <div class="dropped-block-title">
                        ${getBlockIcon(blockData.name)}
                        <span>${getBlockLabel(blockData.name)}</span>
                    </div>
                    <div class="block-actions">
                        <button class="move-block" onclick="moveBlockUp('${blockId}', '${zone}')" title="Mover arriba">▲</button>
                        <button class="move-block" onclick="moveBlockDown('${blockId}', '${zone}')" title="Mover abajo">▼</button>
                        <button class="remove-block" onclick="removeBlock('${blockId}', '${zone}')">✕</button>
                    </div>
                </div>
                ${paramsHtml}
            `;
            
            contentElement.appendChild(droppedBlock);
            
            // Guardar en configuración
            strategyConfig[zone].push({
                id: blockId,
                type: blockData.type,
                name: blockData.name
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zone);
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function removeBlock(blockId, zone) {
            const block = document.querySelector(`[data-block-id="${blockId}"]`);
            if (block) {
                block.remove();
            }
            
            // Remover de configuración
            strategyConfig[zone] = strategyConfig[zone].filter(b => b.id !== blockId);
            
            // Si la zona quedó vacía, mostrar mensaje
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            if (contentElement.children.length === 0) {
                const lang = localStorage.getItem('language') || 'en';
                const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
                contentElement.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            } else {
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
            }
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function moveBlockUp(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex > 0) {
                // Intercambiar con el bloque anterior
                const previousBlock = blocks[currentIndex - 1];
                contentElement.insertBefore(blockElement, previousBlock);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex - 1];
                strategyConfig[zone][currentIndex - 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function moveBlockDown(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex < blocks.length - 1) {
                // Intercambiar con el bloque siguiente
                const nextBlock = blocks[currentIndex + 1];
                contentElement.insertBefore(nextBlock, blockElement);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex + 1];
                strategyConfig[zone][currentIndex + 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function updateMoveButtons(zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            
            blocks.forEach((block, index) => {
                const upButton = block.querySelector('.move-block:nth-of-type(1)');
                const downButton = block.querySelector('.move-block:nth-of-type(2)');
                
                if (upButton) {
                    upButton.disabled = (index === 0);
                }
                if (downButton) {
                    downButton.disabled = (index === blocks.length - 1);
                }
            });
        }

        function clearStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            const confirmMsg = lang === 'es' 
                ? '¿Estás seguro de limpiar toda la estrategia?' 
                : 'Are you sure you want to clear the entire strategy?';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function exportStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            
            // Recolectar todos los bloques de cada zona
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            // Validar que hay al menos una estrategia
            const hasBlocks = strategy.entry_long.length > 0 || 
                             strategy.exit_long.length > 0 || 
                             strategy.entry_short.length > 0 || 
                             strategy.exit_short.length > 0;
            
            if (!hasBlocks) {
                const msg = lang === 'es' 
                    ? 'No hay estrategia para exportar. Arrastra bloques primero.'
                    : 'No strategy to export. Drag blocks first.';
                alert(msg);
                return;
            }
            
            // Crear archivo JSON
            const dataStr = JSON.stringify(strategy, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Descargar archivo
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `strategy_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            const successMsg = lang === 'es'
                ? '✅ Estrategia exportada exitosamente!'
                : '✅ Strategy exported successfully!';
            alert(successMsg);
        }
        
        function extractBlocksFromZone(zoneId) {
            const zone = document.getElementById(zoneId);
            if (!zone) {
                console.warn(`Zone not found: ${zoneId}`);
                return [];
            }
            
            const blocks = [];
            const blockElements = zone.querySelectorAll('.dropped-block');
            
            blockElements.forEach(block => {
                const blockData = {
                    type: block.dataset.type,
                    name: block.dataset.name,
                    params: {}
                };
                
                // Extraer valores de parámetros
                const inputs = block.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.id) {
                        blockData.params[input.id] = input.value;
                    }
                });
                
                blocks.push(blockData);
            });
            
            return blocks;
        }
        
        function importStrategy(event) {
            const lang = localStorage.getItem('language') || 'en';
            const file = event.target.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const strategy = JSON.parse(e.target.result);
                
                // Validar estructura básica
                if (!strategy.version || !strategy.entry_long) {
                    const errorMsg = lang === 'es'
                        ? '❌ Error al importar estrategia. Verifica que el archivo sea válido.'
                        : '❌ Error importing strategy. Verify the file is valid.';
                    alert(errorMsg);
                    return;
                }
                
                // Limpiar estrategia actual
                clearStrategyWithoutConfirm();
                
                // Cargar bloques en cada zona
                loadBlocksToZone('entry_long_zone', strategy.entry_long);
                loadBlocksToZone('exit_long_zone', strategy.exit_long);
                loadBlocksToZone('entry_short_zone', strategy.entry_short);
                loadBlocksToZone('exit_short_zone', strategy.exit_short);
                
                // Actualizar información de estrategia
                updateStrategyInfo();
                
                const successMsg = lang === 'es'
                    ? '✅ Estrategia importada exitosamente!'
                    : '✅ Strategy imported successfully!';
                alert(successMsg);
            };
            
            reader.readAsText(file);
            
            // Reset input para permitir reimportar el mismo archivo
            event.target.value = '';
        }
        
        function clearStrategyWithoutConfirm() {
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const lang = localStorage.getItem('language') || 'en';
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }
        
        function loadBlocksToZone(zoneId, blocks) {
            if (!blocks || blocks.length === 0) return;
            
            const zone = document.getElementById(zoneId);
            if (!zone) return;
            
            const zoneName = zone.dataset.zone;
            if (!zoneName) return;
            
            // Limpiar configuración de esta zona
            strategyConfig[zoneName] = [];
            
            // Agregar cada bloque usando la misma función que cuando se arrastra
            blocks.forEach((blockData) => {
                // Recrear el bloque con sus parámetros guardados
                const blockToAdd = {
                    type: blockData.type,
                    name: blockData.name,
                    params: blockData.params
                };
                
                addBlockToZone(zoneName, blockToAdd);
                
                // Ahora actualizar los valores de los parámetros después de crear el bloque
                if (blockData.params) {
                    // Obtener el último bloque agregado
                    const droppedBlocks = zone.querySelectorAll('.dropped-block');
                    const lastBlock = droppedBlocks[droppedBlocks.length - 1];
                    
                    if (lastBlock) {
                        // Aplicar los valores guardados a los inputs
                        Object.entries(blockData.params).forEach(([paramId, paramValue]) => {
                            const input = lastBlock.querySelector(`#${paramId}`);
                            if (input) {
                                input.value = paramValue;
                            } else {
                                // Si el ID exacto no existe, buscar por el sufijo del parámetro
                                const paramSuffix = paramId.split('_').pop();
                                const inputBySuffix = lastBlock.querySelector(`[id$="_${paramSuffix}"]`);
                                if (inputBySuffix) {
                                    inputBySuffix.value = paramValue;
                                }
                            }
                        });
                    }
                }
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zoneName);
        }

        function getBlockIcon(name) {
            const icons = {
                'EMA': '📊',
                'SMA': '📈',
                'RSI': '⚡',
                'MACD': '🌊',
                'BBands': '📏',
                'ATR': '📊',
                'Swing': '🔄',
                'Price': '💵',
                'Number': '🔢',
                'Percentage': '📊',
                'GreaterThan': '>',
                'LessThan': '<',
                'GreaterOrEqual': '≥',
                'LessOrEqual': '≤',
                'Equal': '=',
                'NotEqual': '≠',
                'Crosses': '✖️',
                'AND': '∧',
                'OR': '∨',
                'NOT': '¬',
                'XOR': '⊕',
                'NAND': '⊼',
                'NOR': '⊽'
            };
            return icons[name] || '📦';
        }

        function getBlockLabel(name) {
            const labels = {
                'EMA': 'EMA',
                'SMA': 'SMA',
                'RSI': 'RSI',
                'MACD': 'MACD',
                'BBands': 'Bollinger',
                'ATR': 'ATR',
                'Swing': 'Swing',
                'Price': 'Precio',
                'Number': 'Número',
                'Percentage': 'Porcentaje',
                'GreaterThan': 'Mayor que',
                'LessThan': 'Menor que',
                'GreaterOrEqual': 'Mayor/Igual',
                'LessOrEqual': 'Menor/Igual',
                'Equal': 'Igual',
                'NotEqual': 'Diferente',
                'Crosses': 'Cruza',
                'AND': 'AND',
                'OR': 'OR',
                'NOT': 'NOT',
                'XOR': 'XOR',
                'NAND': 'NAND',
                'NOR': 'NOR'
            };
            return labels[name] || name;
        }

        function getStrategyParams() {
            // Extraer parámetros de todos los bloques
            const params = {
                indicators: [],
                conditions: {}
            };
            
            // Buscar bloques EMA - solo si existen
            const emaBlocks = document.querySelectorAll('.dropped-block[data-name="EMA"]');
            if (emaBlocks.length > 0) {
                const firstEMA = emaBlocks[0].querySelector('[id$="_period"]');
                if (firstEMA && firstEMA.value) {
                    params.ema_period = parseInt(firstEMA.value);
                }
            }
            
            // Buscar bloques Swing - solo si existen
            const swingBlocks = document.querySelectorAll('.dropped-block[data-name="Swing"]');
            if (swingBlocks.length > 0) {
                const firstSwing = swingBlocks[0].querySelector('[id$="_lookback"]');
                if (firstSwing && firstSwing.value) {
                    params.swing_lookback = parseInt(firstSwing.value);
                }
            }
            
            // Recopilar todos los indicadores configurados
            document.querySelectorAll('.dropped-block[data-type="indicator"]').forEach(block => {
                const indicator = {
                    type: block.dataset.name,
                    params: {}
                };
                
                // Extraer parámetros específicos
                block.querySelectorAll('input, select').forEach(input => {
                    const paramName = input.id.split('_').pop();
                    indicator.params[paramName] = input.value;
                });
                
                params.indicators.push(indicator);
            });
            
            return params;
        }
        
        function getFullStrategyData() {
            // Recolectar todos los bloques de cada zona para enviar al backend
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            return strategy;
        }

        // initStrategyBuilder ya está definida arriba - NO DUPLICAR
        // updateStrategyInfo ya está definida arriba - NO DUPLICAR
        
        function translateStrategyToHuman(lang) {
            const zones = [
                { id: 'entry_long_zone', label: lang === 'es' ? '📈 Entrada LONG' : '📈 LONG Entry' },
                { id: 'exit_long_zone', label: lang === 'es' ? '🚪 Salida LONG' : '🚪 LONG Exit' },
                { id: 'entry_short_zone', label: lang === 'es' ? '📉 Entrada SHORT' : '📉 SHORT Entry' },
                { id: 'exit_short_zone', label: lang === 'es' ? '🔚 Salida SHORT' : '🔚 SHORT Exit' }
            ];
            
            let html = '<div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); border-radius: 6px; border-left: 3px solid #667eea;">';
            html += `<strong style="color: #764ba2;">${lang === 'es' ? '🔍 Traducción de Estrategia:' : '🔍 Strategy Translation:'}</strong><br>`;
            
            let hasConditions = false;
            zones.forEach(zone => {
                const zoneElement = document.getElementById(zone.id);
                if (!zoneElement) return;
                
                const blocks = zoneElement.querySelectorAll('.dropped-block');
                if (blocks.length === 0) return;
                
                hasConditions = true;
                html += `<br><strong style="color: #667eea;">${zone.label}:</strong><br>`;
                
                blocks.forEach((block, index) => {
                    const blockName = block.dataset.name;
                    const blockType = block.dataset.type;
                    const description = getBlockDescription(blockName, blockType, block, lang);
                    html += `${index + 1}. ${description}<br>`;
                });
            });
            
            html += '</div>';
            return hasConditions ? html : '';
        }
        
        function getBlockDescription(name, type, blockElement, lang) {
            const translations = {
                es: {
                    EMA: 'Media Móvil Exponencial',
                    SMA: 'Media Móvil Simple',
                    RSI: 'Índice de Fuerza Relativa',
                    MACD: 'MACD (Convergencia/Divergencia)',
                    BBands: 'Bandas de Bollinger',
                    ATR: 'Rango Verdadero Promedio',
                    Swing: 'Swing High/Low',
                    Price: 'Precio actual',
                    Number: 'Número',
                    Percentage: 'Porcentaje',
                    GreaterThan: 'Mayor que',
                    LessThan: 'Menor que',
                    GreaterOrEqual: 'Mayor o igual que',
                    LessOrEqual: 'Menor o igual que',
                    Equal: 'Igual a',
                    NotEqual: 'Diferente de',
                    Crosses: 'Cruza',
                    AND: 'Y (ambas condiciones)',
                    OR: 'O (cualquiera)',
                    NOT: 'NO (niega condición)',
                    XOR: 'XOR (solo una)',
                    NAND: 'NAND (no ambas)',
                    NOR: 'NOR (ninguna)'
                },
                en: {
                    EMA: 'Exponential Moving Average',
                    SMA: 'Simple Moving Average',
                    RSI: 'Relative Strength Index',
                    MACD: 'MACD (Convergence/Divergence)',
                    BBands: 'Bollinger Bands',
                    ATR: 'Average True Range',
                    Swing: 'Swing High/Low',
                    Price: 'Current price',
                    Number: 'Number',
                    Percentage: 'Percentage',
                    GreaterThan: 'Greater than',
                    LessThan: 'Less than',
                    GreaterOrEqual: 'Greater or equal to',
                    LessOrEqual: 'Less or equal to',
                    Equal: 'Equal to',
                    NotEqual: 'Different from',
                    Crosses: 'Crosses',
                    AND: 'AND (both conditions)',
                    OR: 'OR (any condition)',
                    NOT: 'NOT (negates condition)',
                    XOR: 'XOR (only one)',
                    NAND: 'NAND (not both)',
                    NOR: 'NOR (neither)'
                }
            };
            
            const dict = translations[lang];
            let desc = dict[name] || name;
            
            // Agregar parámetros si existen
            const inputs = blockElement.querySelectorAll('input, select');
            if (inputs.length > 0) {
                const params = [];
                inputs.forEach(input => {
                    if (input.value) {
                        params.push(input.value);
                    }
                });
                if (params.length > 0) {
                    desc += ` (${params.join(', ')})`;
                }
            }
            
            return desc;
        }

        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: this.dataset.type,
                name: this.dataset.name,
                html: this.outerHTML
            }));
            
            // Ocultar paleta después de un pequeño delay
            setTimeout(() => {
                document.querySelector('.blocks-palette').classList.add('dragging');
                document.querySelector('.builder-canvas').classList.add('dragging-active');
                
                // Hacer scroll al canvas para que las cajas sean visibles
                const canvas = document.querySelector('.builder-canvas');
                if (canvas) {
                    canvas.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }
        
        function handleDragEnd(e) {
            // Mostrar paleta nuevamente
            document.querySelector('.blocks-palette').classList.remove('dragging');
            document.querySelector('.builder-canvas').classList.remove('dragging-active');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const zone = this.dataset.zone;
            
            addBlockToZone(zone, data);
        }

        function addBlockToZone(zone, blockData) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            
            // Remover mensaje vacío
            const emptyMsg = contentElement.querySelector('.drop-zone-empty');
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            const blockId = `block_${blockCounter++}`;
            
            // Crear el bloque dropped
            const droppedBlock = document.createElement('div');
            droppedBlock.className = 'dropped-block';
            droppedBlock.dataset.blockId = blockId;
            droppedBlock.dataset.type = blockData.type;
            droppedBlock.dataset.name = blockData.name;
            
            let paramsHtml = '';
            
            // Generar inputs según el tipo de bloque
            if (blockData.name === 'EMA' || blockData.name === 'SMA') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="50" min="1" max="200" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'RSI') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'MACD') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Rápido</label>
                            <input type="number" id="${blockId}_fast" value="12" min="2" max="50" step="1">
                        </div>
                        <div class="param-group">
                            <label>Lento</label>
                            <input type="number" id="${blockId}_slow" value="26" min="2" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Señal</label>
                            <input type="number" id="${blockId}_signal" value="9" min="2" max="50" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'BBands') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="20" min="5" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label>Desv. Std</label>
                            <input type="number" id="${blockId}_std" value="2" min="0.5" max="5" step="0.1">
                        </div>
                        <div class="param-group">
                            <label>Banda</label>
                            <select id="${blockId}_band">
                                <option value="upper">Superior</option>
                                <option value="middle">Media</option>
                                <option value="lower">Inferior</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'ATR') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Período</label>
                            <input type="number" id="${blockId}_period" value="14" min="2" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Swing') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Tipo</label>
                            <select id="${blockId}_type">
                                <option value="high">High</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label>Lookback</label>
                            <input type="number" id="${blockId}_lookback" value="20" min="5" max="100" step="1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Number') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Valor</label>
                            <input type="number" id="${blockId}_value" value="0" step="0.01">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'Percentage') {
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Porcentaje (%)</label>
                            <input type="number" id="${blockId}_value" value="1" min="0" max="100" step="0.1">
                        </div>
                    </div>
                `;
            } else if (blockData.name === 'GreaterThan' || blockData.name === 'LessThan' || blockData.name === 'GreaterOrEqual' || blockData.name === 'LessOrEqual' || blockData.name === 'Equal' || blockData.name === 'NotEqual' || blockData.name === 'Crosses') {
                const symbol = blockData.name === 'GreaterThan' ? '>' : 
                             blockData.name === 'LessThan' ? '<' : 
                             blockData.name === 'GreaterOrEqual' ? '≥' : 
                             blockData.name === 'LessOrEqual' ? '≤' : 
                             blockData.name === 'Equal' ? '=' : 
                             blockData.name === 'NotEqual' ? '≠' : '✖';
                paramsHtml = `
                    <div class="block-params">
                        <div class="param-group">
                            <label>Comparar</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="text" id="${blockId}_left" placeholder="ej: price, ema50" style="flex: 1;">
                                <span style="font-weight: bold;">${symbol}</span>
                                <input type="text" id="${blockId}_right" placeholder="ej: ema50, swing" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            droppedBlock.innerHTML = `
                <div class="dropped-block-header">
                    <div class="dropped-block-title">
                        ${getBlockIcon(blockData.name)}
                        <span>${getBlockLabel(blockData.name)}</span>
                    </div>
                    <div class="block-actions">
                        <button class="move-block" onclick="moveBlockUp('${blockId}', '${zone}')" title="Mover arriba">▲</button>
                        <button class="move-block" onclick="moveBlockDown('${blockId}', '${zone}')" title="Mover abajo">▼</button>
                        <button class="remove-block" onclick="removeBlock('${blockId}', '${zone}')">✕</button>
                    </div>
                </div>
                ${paramsHtml}
            `;
            
            contentElement.appendChild(droppedBlock);
            
            // Guardar en configuración
            strategyConfig[zone].push({
                id: blockId,
                type: blockData.type,
                name: blockData.name
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zone);
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function removeBlock(blockId, zone) {
            const block = document.querySelector(`[data-block-id="${blockId}"]`);
            if (block) {
                block.remove();
            }
            
            // Remover de configuración
            strategyConfig[zone] = strategyConfig[zone].filter(b => b.id !== blockId);
            
            // Si la zona quedó vacía, mostrar mensaje
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            if (contentElement.children.length === 0) {
                const lang = localStorage.getItem('language') || 'en';
                const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
                contentElement.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            } else {
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
            }
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function moveBlockUp(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex > 0) {
                // Intercambiar con el bloque anterior
                const previousBlock = blocks[currentIndex - 1];
                contentElement.insertBefore(blockElement, previousBlock);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex - 1];
                strategyConfig[zone][currentIndex - 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function moveBlockDown(blockId, zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const currentIndex = blocks.indexOf(blockElement);
            
            if (currentIndex < blocks.length - 1) {
                // Intercambiar con el bloque siguiente
                const nextBlock = blocks[currentIndex + 1];
                contentElement.insertBefore(nextBlock, blockElement);
                
                // Actualizar configuración
                const temp = strategyConfig[zone][currentIndex];
                strategyConfig[zone][currentIndex] = strategyConfig[zone][currentIndex + 1];
                strategyConfig[zone][currentIndex + 1] = temp;
                
                // Actualizar botones de movimiento
                updateMoveButtons(zone);
                updateStrategyInfo();
            }
        }

        function updateMoveButtons(zone) {
            const zoneElement = document.querySelector(`[data-zone="${zone}"]`);
            const contentElement = zoneElement.querySelector('.drop-zone-content');
            const blocks = Array.from(contentElement.querySelectorAll('.dropped-block'));
            
            blocks.forEach((block, index) => {
                const upButton = block.querySelector('.move-block:nth-of-type(1)');
                const downButton = block.querySelector('.move-block:nth-of-type(2)');
                
                if (upButton) {
                    upButton.disabled = (index === 0);
                }
                if (downButton) {
                    downButton.disabled = (index === blocks.length - 1);
                }
            });
        }

        function clearStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            const confirmMsg = lang === 'es' 
                ? '¿Estás seguro de limpiar toda la estrategia?' 
                : 'Are you sure you want to clear the entire strategy?';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }

        function exportStrategy() {
            const lang = localStorage.getItem('language') || 'en';
            
            // Recolectar todos los bloques de cada zona
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            // Validar que hay al menos una estrategia
            const hasBlocks = strategy.entry_long.length > 0 || 
                             strategy.exit_long.length > 0 || 
                             strategy.entry_short.length > 0 || 
                             strategy.exit_short.length > 0;
            
            if (!hasBlocks) {
                const msg = lang === 'es' 
                    ? 'No hay estrategia para exportar. Arrastra bloques primero.'
                    : 'No strategy to export. Drag blocks first.';
                alert(msg);
                return;
            }
            
            // Crear archivo JSON
            const dataStr = JSON.stringify(strategy, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Descargar archivo
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `strategy_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            const successMsg = lang === 'es'
                ? '✅ Estrategia exportada exitosamente!'
                : '✅ Strategy exported successfully!';
            alert(successMsg);
        }
        
        function extractBlocksFromZone(zoneId) {
            const zone = document.getElementById(zoneId);
            if (!zone) {
                console.warn(`Zone not found: ${zoneId}`);
                return [];
            }
            
            const blocks = [];
            const blockElements = zone.querySelectorAll('.dropped-block');
            
            blockElements.forEach(block => {
                const blockData = {
                    type: block.dataset.type,
                    name: block.dataset.name,
                    params: {}
                };
                
                // Extraer valores de parámetros
                const inputs = block.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.id) {
                        blockData.params[input.id] = input.value;
                    }
                });
                
                blocks.push(blockData);
            });
            
            return blocks;
        }
        
        function importStrategy(event) {
            const lang = localStorage.getItem('language') || 'en';
            const file = event.target.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const strategy = JSON.parse(e.target.result);
                
                // Validar estructura básica
                if (!strategy.version || !strategy.entry_long) {
                    const errorMsg = lang === 'es'
                        ? '❌ Error al importar estrategia. Verifica que el archivo sea válido.'
                        : '❌ Error importing strategy. Verify the file is valid.';
                    alert(errorMsg);
                    return;
                }
                
                // Limpiar estrategia actual
                clearStrategyWithoutConfirm();
                
                // Cargar bloques en cada zona
                loadBlocksToZone('entry_long_zone', strategy.entry_long);
                loadBlocksToZone('exit_long_zone', strategy.exit_long);
                loadBlocksToZone('entry_short_zone', strategy.entry_short);
                loadBlocksToZone('exit_short_zone', strategy.exit_short);
                
                // Actualizar información de estrategia
                updateStrategyInfo();
                
                const successMsg = lang === 'es'
                    ? '✅ Estrategia importada exitosamente!'
                    : '✅ Strategy imported successfully!';
                alert(successMsg);
            };
            
            reader.readAsText(file);
            
            // Reset input para permitir reimportar el mismo archivo
            event.target.value = '';
        }
        
        function clearStrategyWithoutConfirm() {
            strategyConfig = {
                entry_long: [],
                exit_long: [],
                entry_short: [],
                exit_short: []
            };
            
            const lang = localStorage.getItem('language') || 'en';
            const msg = lang === 'es' ? 'Arrastra bloques aquí' : 'Drag blocks here';
            document.querySelectorAll('.drop-zone-content').forEach(content => {
                content.innerHTML = `<div class="drop-zone-empty">${msg}</div>`;
            });
            
            // Actualizar información de estrategia
            updateStrategyInfo();
        }
        
        function loadBlocksToZone(zoneId, blocks) {
            if (!blocks || blocks.length === 0) return;
            
            const zone = document.getElementById(zoneId);
            if (!zone) return;
            
            const zoneName = zone.dataset.zone;
            if (!zoneName) return;
            
            // Limpiar configuración de esta zona
            strategyConfig[zoneName] = [];
            
            // Agregar cada bloque usando la misma función que cuando se arrastra
            blocks.forEach((blockData) => {
                // Recrear el bloque con sus parámetros guardados
                const blockToAdd = {
                    type: blockData.type,
                    name: blockData.name,
                    params: blockData.params
                };
                
                addBlockToZone(zoneName, blockToAdd);
                
                // Ahora actualizar los valores de los parámetros después de crear el bloque
                if (blockData.params) {
                    // Obtener el último bloque agregado
                    const droppedBlocks = zone.querySelectorAll('.dropped-block');
                    const lastBlock = droppedBlocks[droppedBlocks.length - 1];
                    
                    if (lastBlock) {
                        // Aplicar los valores guardados a los inputs
                        Object.entries(blockData.params).forEach(([paramId, paramValue]) => {
                            const input = lastBlock.querySelector(`#${paramId}`);
                            if (input) {
                                input.value = paramValue;
                            } else {
                                // Si el ID exacto no existe, buscar por el sufijo del parámetro
                                const paramSuffix = paramId.split('_').pop();
                                const inputBySuffix = lastBlock.querySelector(`[id$="_${paramSuffix}"]`);
                                if (inputBySuffix) {
                                    inputBySuffix.value = paramValue;
                                }
                            }
                        });
                    }
                }
            });
            
            // Actualizar botones de movimiento
            updateMoveButtons(zoneId);
        }

        function getBlockIcon(name) {
            const icons = {
                'EMA': '📊',
                'SMA': '📈',
                'RSI': '⚡',
                'MACD': '🌊',
                'BBands': '📏',
                'ATR': '📊',
                'Swing': '🔄',
                'Price': '💵',
                'Number': '🔢',
                'Percentage': '📊',
                'GreaterThan': '>',
                'LessThan': '<',
                'GreaterOrEqual': '≥',
                'LessOrEqual': '≤',
                'Equal': '=',
                'NotEqual': '≠',
                'Crosses': '✖️',
                'AND': '∧',
                'OR': '∨',
                'NOT': '¬',
                'XOR': '⊕',
                'NAND': '⊼',
                'NOR': '⊽'
            };
            return icons[name] || '📦';
        }

        function getBlockLabel(name) {
            const labels = {
                'EMA': 'EMA',
                'SMA': 'SMA',
                'RSI': 'RSI',
                'MACD': 'MACD',
                'BBands': 'Bollinger',
                'ATR': 'ATR',
                'Swing': 'Swing',
                'Price': 'Precio',
                'Number': 'Número',
                'Percentage': 'Porcentaje',
                'GreaterThan': 'Mayor que',
                'LessThan': 'Menor que',
                'GreaterOrEqual': 'Mayor/Igual',
                'LessOrEqual': 'Menor/Igual',
                'Equal': 'Igual',
                'NotEqual': 'Diferente',
                'Crosses': 'Cruza',
                'AND': 'AND',
                'OR': 'OR',
                'NOT': 'NOT',
                'XOR': 'XOR',
                'NAND': 'NAND',
                'NOR': 'NOR'
            };
            return labels[name] || name;
        }

        function getStrategyParams() {
            // Extraer parámetros de todos los bloques
            const params = {
                indicators: [],
                conditions: {}
            };
            
            // Buscar bloques EMA - solo si existen
            const emaBlocks = document.querySelectorAll('.dropped-block[data-name="EMA"]');
            if (emaBlocks.length > 0) {
                const firstEMA = emaBlocks[0].querySelector('[id$="_period"]');
                if (firstEMA && firstEMA.value) {
                    params.ema_period = parseInt(firstEMA.value);
                }
            }
            
            // Buscar bloques Swing - solo si existen
            const swingBlocks = document.querySelectorAll('.dropped-block[data-name="Swing"]');
            if (swingBlocks.length > 0) {
                const firstSwing = swingBlocks[0].querySelector('[id$="_lookback"]');
                if (firstSwing && firstSwing.value) {
                    params.swing_lookback = parseInt(firstSwing.value);
                }
            }
            
            // Recopilar todos los indicadores configurados
            document.querySelectorAll('.dropped-block[data-type="indicator"]').forEach(block => {
                const indicator = {
                    type: block.dataset.name,
                    params: {}
                };
                
                // Extraer parámetros específicos
                block.querySelectorAll('input, select').forEach(input => {
                    const paramName = input.id.split('_').pop();
                    indicator.params[paramName] = input.value;
                });
                
                params.indicators.push(indicator);
            });
            
            return params;
        }
        
        function getFullStrategyData() {
            // Recolectar todos los bloques de cada zona para enviar al backend
            const strategy = {
                version: "2.2",
                timestamp: new Date().toISOString(),
                entry_long: extractBlocksFromZone('entry_long_zone'),
                exit_long: extractBlocksFromZone('exit_long_zone'),
                entry_short: extractBlocksFromZone('entry_short_zone'),
                exit_short: extractBlocksFromZone('exit_short_zone')
            };
            
            return strategy;
        }

        // initStrategyBuilder ya está definida arriba - NO DUPLICAR
        // updateStrategyInfo ya está definida arriba - NO DUPLICAR
        
        function translateStrategyToHuman(lang) {
            const zones = [
                { id: 'entry_long_zone', label: lang === 'es' ? '📈 Entrada LONG' : '📈 LONG Entry' },
                { id: 'exit_long_zone', label: lang === 'es' ? '🚪 Salida LONG' : '🚪 LONG Exit' },
                { id: 'entry_short_zone', label: lang === 'es' ? '📉 Entrada SHORT' : '📉 SHORT Entry' },
                { id: 'exit_short_zone', label: lang === 'es' ? '🔚 Salida SHORT' : '🔚 SHORT Exit' }
            ];
            
            let html = '<div style="margin-top: 10px; padding: 10px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); border-radius: 6px; border-left: 3px solid #667eea;">';
            html += `<strong style="color: #764ba2;">${lang === 'es' ? '🔍 Traducción de Estrategia:' : '🔍 Strategy Translation:'}</strong><br>`;
            
            let hasConditions = false;
            zones.forEach(zone => {
                const zoneElement = document.getElementById(zone.id);
                if (!zoneElement) return;
                
                const blocks = zoneElement.querySelectorAll('.dropped-block');
                if (blocks.length === 0) return;
                
                hasConditions = true;
                html += `<br><strong style="color: #667eea;">${zone.label}:</strong><br>`;
                
                blocks.forEach((block, index) => {
                    const blockName = block.dataset.name;
                    const blockType = block.dataset.type;
                    const description = getBlockDescription(blockName, blockType, block, lang);
                    html += `${index + 1}. ${description}<br>`;
                });
            });
            
            html += '</div>';
            return hasConditions ? html : '';
        }
        
        function getBlockDescription(name, type, blockElement, lang) {
            const translations = {
                es: {
                    EMA: 'Media Móvil Exponencial',
                    SMA: 'Media Móvil Simple',
                    RSI: 'Índice de Fuerza Relativa',
                    MACD: 'MACD (Convergencia/Divergencia)',
                    BBands: 'Bandas de Bollinger',
                    ATR: 'Rango Verdadero Promedio',
                    Swing: 'Swing High/Low',
                    Price: 'Precio actual',
                    Number: 'Número',
                    Percentage: 'Porcentaje',
                    GreaterThan: 'Mayor que',
                    LessThan: 'Menor que',
                    GreaterOrEqual: 'Mayor o igual que',
                    LessOrEqual: 'Menor o igual que',
                    Equal: 'Igual a',
                    NotEqual: 'Diferente de',
                    Crosses: 'Cruza',
                    AND: 'Y (ambas condiciones)',
                    OR: 'O (cualquiera)',
                    NOT: 'NO (niega condición)',
                    XOR: 'XOR (solo una)',
                    NAND: 'NAND (no ambas)',
                    NOR: 'NOR (ninguna)'
                },
                en: {
                    EMA: 'Exponential Moving Average',
                    SMA: 'Simple Moving Average',
                    RSI: 'Relative Strength Index',
                    MACD: 'MACD (Convergence/Divergence)',
                    BBands: 'Bollinger Bands',
                    ATR: 'Average True Range',
                    Swing: 'Swing High/Low',
                    Price: 'Current price',
                    Number: 'Number',
                    Percentage: 'Percentage',
                    GreaterThan: 'Greater than',
                    LessThan: 'Less than',
                    GreaterOrEqual: 'Greater or equal to',
                    LessOrEqual: 'Less or equal to',
                    Equal: 'Equal to',
                    NotEqual: 'Different from',
                    Crosses: 'Crosses',
                    AND: 'AND (both conditions)',
                    OR: 'OR (any condition)',
                    NOT: 'NOT (negates condition)',
                    XOR: 'XOR (only one)',
                    NAND: 'NAND (not both)',
                    NOR: 'NOR (neither)'
                }
            };
            
            const dict = translations[lang];
            let desc = dict[name] || name;
            
            // Agregar parámetros si existen
            const inputs = blockElement.querySelectorAll('input, select');
            if (inputs.length > 0) {
                const params = [];
                inputs.forEach(input => {
                    if (input.value) {
                        params.push(input.value);
                    }
                });
                if (params.length > 0) {
                    desc += ` (${params.join(', ')})`;
                }
            }
            
            return desc;
        }

        function handleDragStart(e) {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: this.dataset.type,
                name: this.dataset.name,
                html: this.outerHTML
            }));
            
            // Ocultar paleta después de un pequeño delay
            setTimeout(() => {
                document.querySelector('.blocks-palette').classList.add('dragging');
                document.querySelector('.builder-canvas').classList.add('dragging-active');
                
                // Hacer scroll al canvas para que las cajas sean visibles
                const canvas = document.querySelector('.builder-canvas');
                if (canvas) {
                    canvas.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }
        
        function handleDragEnd(e) {
            // Mostrar paleta nuevamente
            document.querySelector('.blocks-palette').classList.remove('dragging');
            document.querySelector('.builder-canvas').classList.remove('dragging-active');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const zone = this.dataset.zone;
            
            addBlockToZone(zone, data);
        }

        // ==================== MENU UNIVERSAL FUNCTIONS ====================
        function toggleUniversalMenu() {
            const menu = document.getElementById('universalMenu');
            menu.classList.toggle('active');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            console.log('🌙 Dark mode:', isDark ? 'ON' : 'OFF');
        }

        function toggleLanguage() {
            const currentLang = localStorage.getItem('language') || 'es';
            const newLang = currentLang === 'es' ? 'en' : 'es';
            localStorage.setItem('language', newLang);
            
            // Actualizar todos los elementos con atributos de idioma
            document.querySelectorAll('[data-lang-es][data-lang-en]').forEach(element => {
                const text = element.getAttribute('data-lang-' + newLang);
                if (text) {
                    element.textContent = text;
                }
            });
            
            console.log('🌐 Language changed to:', newLang.toUpperCase());
        }

        function logout() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                window.location.href = '/logout';
            }
        }

        // Verificar si el usuario es admin para mostrar link del panel
        async function checkUniversalMenuAdmin() {
            try {
                const response = await fetch('/api/user-info');
                const data = await response.json();
                const isAdmin = data.user?.role === 'admin' || data.is_admin === true;
                
                if (isAdmin) {
                    const adminLink = document.getElementById('adminMenuLink');
                    if (adminLink) {
                        adminLink.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error checking admin for menu:', error);
            }
        }

        // Cerrar el menú al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('universalMenu');
            const menuBtn = event.target.closest('.menu-btn');
            
            if (!menuBtn && !event.target.closest('.universal-menu-content')) {
                menu.classList.remove('active');
            }
        });

        // Aplicar dark mode y language al cargar
        document.addEventListener('DOMContentLoaded', function() {
            // Dark mode
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
            }
            
            // Language
            const savedLang = localStorage.getItem('language') || 'es';
            document.querySelectorAll('[data-lang-es][data-lang-en]').forEach(element => {
                const text = element.getAttribute('data-lang-' + savedLang);
                if (text) {
                    element.textContent = text;
                }
            });
            
            // Verificar admin para menú
            checkUniversalMenuAdmin();
        });

    </script>

    <!-- Sistema de gestión de suscripciones -->
    <script src="/static/js/subscription_manager.js"></script>

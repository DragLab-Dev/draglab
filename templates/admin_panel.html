<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - DragLab</title>
    <style>
        /* MEN√ö UNIVERSAL INLINE */
        .universal-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        .universal-menu .menu-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.9);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .universal-menu .menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        .universal-menu-content {
            position: absolute;
            right: 0;
            top: 60px;
            background: white;
            min-width: 250px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .universal-menu-content.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .universal-menu-content a,
        .universal-menu-content button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            text-decoration: none;
            color: #333;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .universal-menu-content a:hover,
        .universal-menu-content button:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .universal-menu-content .menu-divider {
            height: 1px;
            background: rgba(0,0,0,0.1);
            margin: 5px 0;
        }
        body.dark-mode .universal-menu-content {
            background: #1e1e2e;
        }
        body.dark-mode .universal-menu-content a,
        body.dark-mode .universal-menu-content button {
            color: #fff;
        }
        body.dark-mode .universal-menu-content .menu-divider {
            background: rgba(255,255,255,0.1);
        }
        /* FIN MEN√ö UNIVERSAL */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 28px;
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .admin-info {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .users-table {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .users-table h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .filters-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-create {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .role-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .role-admin {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .role-user {
            background: #e0e0e0;
            color: #666;
        }
        
        .status-verified {
            color: #4caf50;
            font-weight: bold;
        }
        
        .status-unverified {
            color: #ff9800;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            box-shadow: 0 4px 12px rgba(244,67,54,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            margin-right: 5px;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%);
            box-shadow: 0 4px 12px rgba(255,152,0,0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            margin-right: 5px;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 12px rgba(33,150,243,0.4);
        }
        
        .btn-back {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(102,126,234,0.1);
            border: 2px solid rgba(102,126,234,0.2);
            color: #667eea;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 1000;
            text-decoration: none;
        }
        
        .btn-back:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102,126,234,0.3);
            background: rgba(102,126,234,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .password-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 16px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .btn-close {
            background: #666;
            color: white;
        }
        
        .btn-close:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <!-- MEN√ö UNIVERSAL -->
    <div class="universal-menu">
        <button class="menu-btn" onclick="toggleUniversalMenu()" title="Men√∫">‚ò∞</button>
        <div class="universal-menu-content" id="universalMenu">
            <a href="/">üè† Inicio</a>
            <a href="/backtest">üß± Visual Strategy Builder</a>
            <a href="/trading-bot">ü§ñ Trading Bot</a>
            <div class="menu-divider"></div>
            <a href="/user-panel">üë§ Mi Cuenta</a>
            <a href="/subscriptions">üíé Suscripciones</a>
            <a href="/admin/panel" id="adminMenuLink" style="display: none;">üîí Panel Admin</a>
            <div class="menu-divider"></div>
            <button onclick="toggleDarkMode()">üåô Modo Oscuro</button>
            <button onclick="toggleLanguage()">üåê Idioma</button>
            <div class="menu-divider"></div>
            <button onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üîê Panel de Administraci√≥n</h1>
            <div class="admin-info">
                <span class="admin-badge">DRAGLAB</span>
                <span>{{ admin.name }}</span>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Usuarios</h3>
                <div class="stat-value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Usuarios Verificados</h3>
                <div class="stat-value" id="verifiedUsers">-</div>
            </div>
            <div class="stat-card">
                <h3>Administradores</h3>
                <div class="stat-value" id="adminCount">-</div>
            </div>
            <div class="stat-card">
                <h3>Sesiones Activas</h3>
                <div class="stat-value" id="activeSessions">-</div>
            </div>
        </div>
        
        <div class="users-table">
            <h2>Gesti√≥n de Usuarios</h2>
            
            <div class="filters-section">
                <input type="text" id="filterEmail" class="filter-input" placeholder="üîç Buscar por email..." oninput="filterUsers()">
                <select id="filterRole" class="filter-select" onchange="filterUsers()">
                    <option value="">Todos los roles</option>
                    <option value="admin">Administradores</option>
                    <option value="user">Usuarios</option>
                </select>
                <select id="filterVerified" class="filter-select" onchange="filterUsers()">
                    <option value="">Todos los estados</option>
                    <option value="1">Verificados</option>
                    <option value="0">No verificados</option>
                </select>
                <button class="btn-create" onclick="openCreateUserModal()">‚ûï Crear Usuario</button>
            </div>
            
            <div id="tableContent" class="loading">Cargando usuarios...</div>
        </div>
    </div>
    
    <!-- Modal para mostrar contrase√±a reseteada -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üîë Contrase√±a Reseteada</div>
            <div class="modal-body">
                <p>Nueva contrase√±a temporal para <strong id="resetEmail"></strong>:</p>
                <div class="password-display" id="newPassword"></div>
                <p style="color: #ff9800; font-size: 14px; margin-top: 10px;">
                    ‚ö†Ô∏è IMPORTANTE: Copia esta contrase√±a ahora. No podr√°s verla de nuevo.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="copyPassword()">üìã Copiar</button>
                <button class="btn btn-close" onclick="closePasswordModal()">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para crear usuario -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üë§ Crear Nuevo Usuario</div>
            <div class="modal-body">
                <form id="createUserForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="userEmailInput">üìß Email:</label>
                        <input type="email" id="userEmailInput" name="userEmail" class="form-input" placeholder="usuario@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="userPasswordInput">üîë Contrase√±a:</label>
                        <input type="password" id="userPasswordInput" name="userPassword" class="form-input" placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="form-group">
                        <label for="userNameInput">üë§ Nombre (opcional):</label>
                        <input type="text" id="userNameInput" name="userName" class="form-input" placeholder="Nombre del usuario">
                    </div>
                    <div class="form-group">
                        <label for="userRoleSelect">üé≠ Rol:</label>
                        <select id="userRoleSelect" name="userRole" class="form-input">
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="userVerifiedCheck" name="userVerified">
                            <label for="userVerifiedCheck" style="margin-bottom: 0;">‚úÖ Usuario verificado</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="submitCreateUser()">‚úîÔ∏è Crear Usuario</button>
                <button class="btn btn-close" onclick="closeCreateUserModal()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                const response = await fetch('/admin/api/stats');
                const data = await response.json();
                
                if (data.success && data.stats) {
                    document.getElementById('totalUsers').textContent = data.stats.users.total;
                    document.getElementById('verifiedUsers').textContent = data.stats.users.verified;
                    document.getElementById('adminCount').textContent = data.stats.users.admins;
                    document.getElementById('activeSessions').textContent = '0'; // Por implementar
                } else {
                    console.error('Error en respuesta:', data);
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }
        
        // Cargar usuarios
        async function loadUsers() {
            try {
                const response = await fetch('/admin/api/users');
                const data = await response.json();
                
                // Obtener ID del usuario actual
                const currentUserResponse = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + (localStorage.getItem('session_token') || sessionStorage.getItem('session_token') || '')
                    }
                });
                const currentUserData = await currentUserResponse.json();
                const currentUserId = currentUserData.user ? currentUserData.user.id : null;
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Suscripci√≥n</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.users.forEach((user, index) => {
                    const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
                    const statusClass = user.is_verified ? 'status-verified' : 'status-unverified';
                    const statusText = user.is_verified ? '‚úì Verificado' : '‚óã Sin verificar';
                    const createdDate = new Date(user.created_at).toLocaleDateString('es-ES');
                    
                    const isCurrentUser = user.id === currentUserId;
                    
                    html += `
                        <tr id="user-row-${user.id}">
                            <td><strong>${user.id}</strong></td>
                            <td>${user.email}</td>
                            <td>${user.name || '-'}</td>
                            <td><span class="role-badge ${roleClass}">${user.role.toUpperCase()}</span></td>
                            <td class="${statusClass}">${statusText}</td>
                            <td>${user.subscription_tier}</td>
                            <td>${createdDate}</td>
                            <td style="white-space: nowrap;">
                                ${!isCurrentUser ? `
                                    <button class="btn btn-warning" onclick="resetPassword(${user.id}, '${user.email}')" title="Resetear contrase√±a" style="padding: 6px 12px; margin: 2px;">üîë</button>
                                    <button class="btn btn-info" onclick="changeRole(${user.id}, '${user.role}', '${user.email}')" title="Cambiar rol" style="padding: 6px 12px; margin: 2px;">
                                        ${user.role === 'user' ? '‚¨ÜÔ∏è Admin' : '‚¨áÔ∏è User'}
                                    </button>
                                    <button class="btn ${user.is_verified ? 'btn-warning' : 'btn-info'}" onclick="toggleVerification(${user.id}, ${user.is_verified}, '${user.email}')" title="${user.is_verified ? 'Quitar verificaci√≥n' : 'Verificar usuario'}" style="padding: 6px 12px; margin: 2px;">
                                        ${user.is_verified ? '‚ùå Desverificar' : '‚úÖ Verificar'}
                                    </button>
                                    ${!user.is_verified ? `
                                        <button class="btn btn-info" onclick="resendVerificationCode(${user.id}, '${user.email}')" title="Enviar c√≥digo de verificaci√≥n" style="padding: 6px 12px; margin: 2px;">üìß Enviar</button>
                                    ` : ''}
                                    <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.email}')" title="Eliminar usuario" style="padding: 6px 12px; margin: 2px;">üóëÔ∏è</button>
                                ` : '<span style="color: #999; font-style: italic;">Tu cuenta</span>'}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('tableContent').innerHTML = html;
                
                // Guardar usuarios originales para filtrado
                window.allUsers = data.users;
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                document.getElementById('tableContent').innerHTML = 
                    '<div class="loading">Error al cargar usuarios</div>';
            }
        }
        
        // Eliminar usuario
        async function deleteUser(userId, email) {
            if (!confirm(`¬øEst√°s seguro de eliminar al usuario ${email}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Usuario eliminado exitosamente');
                    loadUsers();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                alert('Error al eliminar usuario');
            }
        }
        
        // Resetear contrase√±a
        async function resetPassword(userId, email) {
            if (!confirm(`¬øResetear la contrase√±a de ${email}?\n\nSe generar√° una contrase√±a temporal aleatoria.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/reset-password`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Mostrar modal con la nueva contrase√±a
                    document.getElementById('resetEmail').textContent = data.email;
                    document.getElementById('newPassword').textContent = data.new_password;
                    document.getElementById('passwordModal').style.display = 'block';
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error reseteando contrase√±a:', error);
                alert('Error al resetear contrase√±a');
            }
        }
        
        // Cambiar rol de usuario
        async function changeRole(userId, currentRole, email) {
            const newRole = currentRole === 'user' ? 'admin' : 'user';
            const action = newRole === 'admin' ? 'PROMOVER a Administrador' : 'DEGRADAR a Usuario Normal';
            
            if (!confirm(`¬ø${action} a ${email}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/change-role`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                if (response.ok) {
                    alert(`Usuario ${email} ahora es ${newRole.toUpperCase()}`);
                    loadUsers();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error cambiando rol:', error);
                alert('Error al cambiar rol');
            }
        }
        
        // Cerrar modal de contrase√±a
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }
        
        // Copiar contrase√±a al portapapeles
        function copyPassword() {
            const password = document.getElementById('newPassword').textContent;
            navigator.clipboard.writeText(password).then(() => {
                alert('Contrase√±a copiada al portapapeles');
            }).catch(err => {
                console.error('Error copiando contrase√±a:', err);
                alert('No se pudo copiar la contrase√±a');
            });
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('passwordModal');
            if (event.target == modal) {
                closePasswordModal();
            }
        }
        
        // Modo noche
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }
        
        // Cargar preferencia de modo noche
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Cambiar idioma
        function changeLanguage(lang) {
            localStorage.setItem('language', lang);
            alert('Idioma cambiado a: ' + lang.toUpperCase());
            // Aqu√≠ se podr√≠a implementar la traducci√≥n real
        }
        
        // Toggle verificaci√≥n de usuario
        async function toggleVerification(userId, currentStatus, email) {
            const action = currentStatus ? 'desverificar' : 'verificar';
            if (!confirm(`¬ø${action} al usuario ${email}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/toggle-verification`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loadUsers();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error cambiando verificaci√≥n:', error);
                alert('Error al cambiar verificaci√≥n');
            }
        }
        
        // Reenviar c√≥digo de verificaci√≥n
        async function resendVerificationCode(userId, email) {
            if (!confirm(`¬øEnviar c√≥digo de verificaci√≥n a ${email}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/users/${userId}/resend-verification`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message + '\n\nC√≥digo (para testing): ' + data.code);
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error enviando c√≥digo:', error);
                alert('Error al enviar c√≥digo de verificaci√≥n');
            }
        }
        
        // Abrir modal crear usuario
        function openCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'flex';
            // Limpiar formulario
            document.getElementById('createUserForm').reset();
        }
        
        // Cerrar modal crear usuario
        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('createUserForm').reset();
        }
        
        // Crear nuevo usuario
        async function submitCreateUser() {
            const email = document.getElementById('userEmailInput').value.trim();
            const password = document.getElementById('userPasswordInput').value.trim();
            const name = document.getElementById('userNameInput').value.trim();
            const role = document.getElementById('userRoleSelect').value;
            const isVerified = document.getElementById('userVerifiedCheck').checked;
            
            if (!email || email.length === 0) {
                alert('El email es obligatorio');
                return;
            }
            
            if (!password || password.length === 0) {
                alert('La contrase√±a es obligatoria');
                return;
            }
            
            if (password.length < 6) {
                alert('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/users/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        name: name,
                        role: role,
                        is_verified: isVerified
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert('‚úÖ ' + data.message);
                    closeCreateUserModal();
                    loadUsers();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error creando usuario:', error);
                alert('Error al crear usuario');
            }
        }
        
        // Filtrar usuarios
        function filterUsers() {
            const emailFilter = document.getElementById('filterEmail').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const verifiedFilter = document.getElementById('filterVerified').value;
            
            if (!window.allUsers) return;
            
            const filteredUsers = window.allUsers.filter(user => {
                const matchEmail = !emailFilter || user.email.toLowerCase().includes(emailFilter);
                const matchRole = !roleFilter || user.role === roleFilter;
                const matchVerified = !verifiedFilter || user.is_verified.toString() === verifiedFilter;
                
                return matchEmail && matchRole && matchVerified;
            });
            
            // Renderizar usuarios filtrados
            renderFilteredUsers(filteredUsers);
        }
        
        // Renderizar usuarios filtrados
        async function renderFilteredUsers(users) {
            // Obtener ID del usuario actual
            const currentUserResponse = await fetch('/api/auth/me', {
                headers: {
                    'Authorization': 'Bearer ' + (localStorage.getItem('session_token') || sessionStorage.getItem('session_token') || '')
                }
            });
            const currentUserData = await currentUserResponse.json();
            const currentUserId = currentUserData.user ? currentUserData.user.id : null;
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Suscripci√≥n</th>
                            <th>Creado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (users.length === 0) {
                html += '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">No se encontraron usuarios</td></tr>';
            } else {
                users.forEach((user, index) => {
                    const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
                    const statusClass = user.is_verified ? 'status-verified' : 'status-unverified';
                    const statusText = user.is_verified ? '‚úì Verificado' : '‚óã Sin verificar';
                    const createdDate = new Date(user.created_at).toLocaleDateString('es-ES');
                    
                    const isCurrentUser = user.id === currentUserId;
                    
                    html += `
                        <tr id="user-row-${user.id}">
                            <td><strong>${user.id}</strong></td>
                            <td>${user.email}</td>
                            <td>${user.name || '-'}</td>
                            <td><span class="role-badge ${roleClass}">${user.role.toUpperCase()}</span></td>
                            <td class="${statusClass}">${statusText}</td>
                            <td>${user.subscription_tier}</td>
                            <td>${createdDate}</td>
                            <td style="white-space: nowrap;">
                                ${!isCurrentUser ? `
                                    <button class="btn btn-warning" onclick="resetPassword(${user.id}, '${user.email}')" title="Resetear contrase√±a" style="padding: 6px 12px; margin: 2px;">üîë</button>
                                    <button class="btn btn-info" onclick="changeRole(${user.id}, '${user.role}', '${user.email}')" title="Cambiar rol" style="padding: 6px 12px; margin: 2px;">
                                        ${user.role === 'user' ? '‚¨ÜÔ∏è Admin' : '‚¨áÔ∏è User'}
                                    </button>
                                    <button class="btn ${user.is_verified ? 'btn-warning' : 'btn-info'}" onclick="toggleVerification(${user.id}, ${user.is_verified}, '${user.email}')" title="${user.is_verified ? 'Quitar verificaci√≥n' : 'Verificar usuario'}" style="padding: 6px 12px; margin: 2px;">
                                        ${user.is_verified ? '‚ùå Desverificar' : '‚úÖ Verificar'}
                                    </button>
                                    ${!user.is_verified ? `
                                        <button class="btn btn-info" onclick="resendVerificationCode(${user.id}, '${user.email}')" title="Enviar c√≥digo de verificaci√≥n" style="padding: 6px 12px; margin: 2px;">üìß Enviar</button>
                                    ` : ''}
                                    <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.email}')" title="Eliminar usuario" style="padding: 6px 12px; margin: 2px;">üóëÔ∏è</button>
                                ` : '<span style="color: #999; font-style: italic;">Tu cuenta</span>'}
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table>';
            document.getElementById('tableContent').innerHTML = html;
        }
        
        // Cerrar modal de contrase√±a al hacer clic fuera
        window.onclick = function(event) {
            const passwordModal = document.getElementById('passwordModal');
            
            if (event.target === passwordModal) {
                closePasswordModal();
            }
            // El modal de crear usuario NO se cierra al hacer clic fuera
        }
        
        // Cargar datos al iniciar
        loadStats();
        loadUsers();
    </script>
    <script>
        /* MEN√ö UNIVERSAL JAVASCRIPT INLINE */
        function toggleUniversalMenu() {
            const menu = document.getElementById('universalMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }
        document.addEventListener('click', function(event) {
            const menu = document.querySelector('.universal-menu');
            const menuContent = document.getElementById('universalMenu');
            if (menu && menuContent && !menu.contains(event.target)) {
                menuContent.classList.remove('active');
            }
        });
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/auth/me')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.user && data.user.role === 'admin') {
                        const adminLink = document.getElementById('adminMenuLink');
                        if (adminLink) adminLink.style.display = 'block';
                    }
                })
                .catch(err => console.error('Error verificando rol:', err));
        });
        /* FIN MEN√ö UNIVERSAL */
    </script>
</body>
</html>


